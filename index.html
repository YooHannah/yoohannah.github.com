<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="My Little World" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="My Little World">
<meta property="og:url" content="http://yoohannah.github.io/index.html">
<meta property="og:site_name" content="My Little World">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My Little World">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoohannah.github.io/"/>





  <title> My Little World </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">My Little World</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">learn and share</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vueAddRoutes.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vueAddRoutes.html" itemprop="url">
                  动态添加路由
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-18T18:07:15+08:00">
                2020-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>需要将动态路由添加到当前静态路由的子路由中<br>即在路由的children属性中添加新路由</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>使用router.addRoutes方法API进行添加</p>
<h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>在beforeEach方法中请求动态路由进行添加，<br>通过设置flag,保证动态路由仅请求一次</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="直接增加同名路由无法覆盖"><a href="#直接增加同名路由无法覆盖" class="headerlink" title="直接增加同名路由无法覆盖"></a>直接增加同名路由无法覆盖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">const routes = [</div><div class="line">  &#123; path: &apos;/foo&apos;,name:&apos;foo&apos;, component: Foo,children:[&#123; path: &apos;/bar2/:id?&apos;,name:&apos;bar2&apos;, component: Foo1 &#125;]&#125;</div><div class="line">]</div><div class="line">const routes1 = [</div><div class="line">  &#123; path: &apos;/foo&apos;,name:&apos;foo&apos;, component: Foo ,children:[&#123; path: &apos;/bar21/:id?&apos;,name:&apos;bar21&apos;, component: Foo2 &#125;]&#125;,</div><div class="line">]</div><div class="line">const router = new VueRouter(&#123;</div><div class="line">  routes</div><div class="line">&#125;)</div><div class="line">router.addRoutes(routes1)</div></pre></td></tr></table></figure>
<p>添加路由记录时，如果之前已经添加过同名路由，则只会警告，不会更新<br>所以如果想通过传入不同的children进行子路由更新无法实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">function addRoutes (routes) &#123;</div><div class="line">  createRouteMap(routes, pathList, pathMap, nameMap);</div><div class="line">&#125;</div><div class="line"></div><div class="line">routes.forEach(function (route) &#123;</div><div class="line">  addRouteRecord(pathList, pathMap, nameMap, route);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">function addRouteRecord ( pathList, pathMap, nameMap ) &#123;</div><div class="line">  //如果有子路由，递归添加到路由表中</div><div class="line">  if (route.children) &#123;</div><div class="line">    route.children.forEach(function (child) &#123;</div><div class="line">      var childMatchAs = matchAs</div><div class="line">        ? cleanPath((matchAs + &quot;/&quot; + (child.path)))</div><div class="line">        : undefined;</div><div class="line">        console.log(childMatchAs)</div><div class="line">      addRouteRecord(pathList, pathMap, nameMap, child, record, childMatchAs);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (!pathMap[record.path]) &#123; 关键！！！！！！详见下文</div><div class="line">    pathList.push(record.path);</div><div class="line">    pathMap[record.path] = record;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (name) &#123;</div><div class="line">    if (!nameMap[name]) &#123; </div><div class="line">      nameMap[name] = record;</div><div class="line">    &#125; else if ( !matchAs) &#123; //直接警告，不更新</div><div class="line">      warn(</div><div class="line">        false,</div><div class="line">        &quot;Duplicate named routes definition: &quot; +</div><div class="line">          &quot;&#123; name: \&quot;&quot; + name + &quot;\&quot;, path: \&quot;&quot; + (record.path) + &quot;\&quot; &#125;&quot;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>addRoutes时，子路由作为children属性，依托父路由添加时，子路由被递归添加后，<br>但父路由因为之前已经添加过，所以不会再对父路由进行任何处理，新添加的子路由<br>不会跟随父路由更新到路由表中，即addRoutes过程不会对原来老路由产生任何变动<br>所以新的子路由也不会被添加进去</p>
<h3 id="解决办法一"><a href="#解决办法一" class="headerlink" title="解决办法一"></a>解决办法一</h3><p>拼接好路由后，通过重新生成matcher对象，清空原始路由信息，再将最终路由添加进去<br><a href="https://github.com/YooHannah/algorithm/blob/master/blog/vueAddRouter1.js" target="_blank" rel="external">详见</a><br>缺点：容易引发各种问题，且引起重复路由</p>
<h3 id="解决办法二"><a href="#解决办法二" class="headerlink" title="解决办法二"></a>解决办法二</h3><p>按照API规则添加路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">router.addRoutes(routes: Array&lt;RouteConfig&gt;)</div><div class="line">动态添加更多的路由规则。参数必须是一个符合 routes 选项要求的数组。</div></pre></td></tr></table></figure></p>
<p>将待更新的路由对象抽离，拿到动态路由拼接好后，与404路由组成数组，直接添加路由<br><a href="https://github.com/YooHannah/algorithm/blob/master/blog/vueAddRouter2.js" target="_blank" rel="external">详见</a></p>
<h2 id="无法正常刷新"><a href="#无法正常刷新" class="headerlink" title="无法正常刷新"></a>无法正常刷新</h2><p>F12刷新浏览器页面后路由对象name为null,无法正常跳转<br>如果直接再在next函数中添加跳转信息会引起无线循环<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">History.prototype.confirmTransition = function confirmTransition (route, onComplete, onAbort) &#123;</div><div class="line">var queue = [].concat(</div><div class="line">  // in-component leave guards</div><div class="line">  extractLeaveGuards(deactivated),</div><div class="line">  // global before hooks</div><div class="line">  this.router.beforeHooks,</div><div class="line">  // in-component update hooks</div><div class="line">  extractUpdateHooks(updated),</div><div class="line">  // in-config enter guards</div><div class="line">  activated.map(function (m) &#123; return m.beforeEnter; &#125;),</div><div class="line">  // async components</div><div class="line">  resolveAsyncComponents(activated)</div><div class="line">);</div><div class="line"></div><div class="line">this.pending = route;</div><div class="line">var iterator = function (hook, next) &#123;</div><div class="line">  if (this$1.pending !== route) &#123;</div><div class="line">    return abort()</div><div class="line">  &#125;</div><div class="line">  try &#123;</div><div class="line">    hook(route, current, function (to) &#123; </div><div class="line">      if (to === false || isError(to)) &#123;</div><div class="line">        // next(false) -&gt; abort navigation, ensure current URL</div><div class="line">        this$1.ensureURL(true);</div><div class="line">        abort(to);</div><div class="line">      &#125; else if (</div><div class="line">        typeof to === &apos;string&apos; ||</div><div class="line">        (typeof to === &apos;object&apos; &amp;&amp;</div><div class="line">          (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</div><div class="line">      ) &#123;</div><div class="line">        // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</div><div class="line">        abort();</div><div class="line">        if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123; </div><div class="line">          this$1.replace(to);</div><div class="line">        &#125; else &#123; </div><div class="line">          this$1.push(to); //引起递归调用</div><div class="line">        &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">        // confirm transition and pass on the value</div><div class="line">        next(to);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125; catch (e) &#123;</div><div class="line">    abort(e);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">&#125;</div><div class="line">History.prototype.push = function push (location, onComplete, onAbort) &#123;</div><div class="line">  var this$1 = this;</div><div class="line"></div><div class="line">  var ref = this;</div><div class="line">  var fromRoute = ref.current;</div><div class="line">  this.transitionTo(location, function (route) &#123;</div><div class="line">    pushState(cleanPath(this$1.base + route.fullPath));</div><div class="line">    handleScroll(this$1.router, route, fromRoute, false);</div><div class="line">    onComplete &amp;&amp; onComplete(route);</div><div class="line">  &#125;, onAbort);</div><div class="line">&#125;;</div><div class="line">History.prototype.transitionTo = function transitionTo (</div><div class="line">  location,</div><div class="line">  onComplete,</div><div class="line">  onAbort</div><div class="line">) &#123;</div><div class="line">  var this$1 = this;</div><div class="line">  var route = this.router.match(location, this.current);</div><div class="line">  this.confirmTransition(...)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在next具体路由后再调用next(),可实现中止导航，即暂停递归</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">if(!hasMenus)&#123;</div><div class="line">  hasMenus = true</div><div class="line">  let temp = await createRoutes() //拿到数据</div><div class="line">  router.addRoutes(temp) //添加路由</div><div class="line">  if(!to.name)&#123; //处理刷新，刷新时，当前页面name会变成null</div><div class="line">    next(&#123;name:to.path.substring(1)&#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">if (to.matched.some(res =&gt; res.meta.requireAuth)) &#123;// 判断是否需要登录权限</div><div class="line">  cookies.getAuthorization().then(token=&gt;&#123;</div><div class="line">    if(!token)&#123;</div><div class="line">      next(&#123;</div><div class="line">        name: &apos;login&apos;,</div><div class="line">        params: &#123;from: to.name&#125;</div><div class="line">      &#125;)</div><div class="line">    &#125;else&#123;</div><div class="line">      next()</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125; else &#123;</div><div class="line">  next() //终止递归</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>多读源码总是用好处的</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/nodejs/i18ntool.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/nodejs/i18ntool.html" itemprop="url">
                  多语言切换文字提取工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-24T18:15:15+08:00">
                2020-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>项目想要添加语言切换功能，负责该任务的同事由于待翻译的文本提取工作量巨大原因产生进度问题<br>项目领导委派我帮忙进行辅助提取的工作</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>  i18n原理就是在全局挂载自己的具有翻译功能的方法，然后将需要翻译的文本作为参数传入，<br>  然后函数根据当前语言环境，调用相应语言的翻译文件，通过key-value形式将对应语言的翻译结果返回给页面显示<br>  项目中以简体中文作为key,翻译结果作为value形成翻译文件<br>  如<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">zh-CN.js 简体中文</div><div class="line">&apos;开始日期&apos;: &apos;开始日期&apos;,</div><div class="line">&apos;结束日期&apos;: &apos;结束日期&apos;,</div><div class="line"></div><div class="line">zh-TW.js 繁体中文</div><div class="line">&apos;开始日期&apos;: &apos;開始日期&apos;,</div><div class="line">&apos;结束日期&apos;: &apos;結束日期&apos;,</div></pre></td></tr></table></figure></p>
<p>  需要做的大量工作就是将项目中前端写的会展示在页面上的文本全部提取出来，形成文件，<br>  并给相应的简体中文地方用i18n全局函数括起来，通过调用函数返回翻译结果</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>因为同事使用纯手工作业，所以进度缓慢，按照这种做法，与其说自己比较懒，一个一个手动改，不如说自己觉得这种方式很low<br>一点都不酷，所以想起之前学习过的nodejs的知识，通过读取文件然后处理文件，最后生成新文件，用新文件替换老文件<br>处理文件过程会将简体中文提取出来形成文本提取文件，新文件中的简体中文会被i18n的全局函数包裹</p>
<h2 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">var fs = require(&apos;fs&apos;); //引入文件处理模块</div><div class="line">function read_file_sync(file_path) &#123;</div><div class="line">  var data = fs.readFileSync(file_path, &apos;utf-8&apos;); //读取文件</div><div class="line">  let arr = file_path.split(&apos;/&apos;)</div><div class="line">  let len = arr.length</div><div class="line">  let temp = arr[len-1].split(&apos;.&apos;)[0] </div><div class="line">  //获取文件名，如果待处理文件是子目录下的，保持生成的文本提取文件和新文件与原来文件保持相同目录结构</div><div class="line">  let fileName = arr[len-2] === &apos;console&apos;?temp:arr.slice(4,arr.length-1).join(&apos;/&apos;)+&apos;/&apos;+temp //子目录情况</div><div class="line">  GetChinese(data,fileName)</div><div class="line">&#125;</div><div class="line">read_file_sync(&apos;./src/components/console/san-manage.vue&apos;)</div></pre></td></tr></table></figure>
<p>提取生成文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">function GetChinese(strValue,fileName) &#123; </div><div class="line">  if(strValue=== null || strValue === &quot;&quot;)&#123; </div><div class="line">    return []</div><div class="line">   &#125;</div><div class="line">  let originData = strValue</div><div class="line">  let arr = getWords(originData) //提取简体中文</div><div class="line">  let obj = &#123;&#125;</div><div class="line">  arr.map(item=&gt;&#123;obj[item]=&apos;&apos;&#125;)</div><div class="line">  let str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</div><div class="line">  str = &apos;export default &apos;+ str</div><div class="line">  //生成文本文件</div><div class="line">  fs.writeFile(&apos;./words/js/&apos;+fileName+&apos;.js&apos;, str,function(err)&#123; </div><div class="line">    if(err) console.log(&apos;提取操作失败&apos;);</div><div class="line">    else console.log(&apos;提取操作成功&apos;);</div><div class="line">  &#125;);</div><div class="line">  //添加i18n全局函数，替换老文件，生成新文件</div><div class="line">  let index = originData.indexOf(&apos;&lt;script&gt;&apos;)</div><div class="line">  let template = originData.substring(0,index)//这里仅替换VUE文件的template模板部分，因为js部分有时涉及到拼接处理，单独处理</div><div class="line">  let templateResult = partTransfor(template) //得到替换结果</div><div class="line">  let other = originData.substring(index)//获取vue文件里面的js部分</div><div class="line">  //二者拼接写入新文件</div><div class="line">  fs.writeFile(&apos;./words/vue/&apos;+fileName+&apos;.vue&apos;, templateResult+other, function(err)&#123; </div><div class="line">    if(err) console.log(&apos;重写文件操作失败&apos;);</div><div class="line">    else console.log(&apos;重写文件操作成功&apos;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="提取"><a href="#提取" class="headerlink" title="提取"></a>提取</h2><p>利用正则提取简体中文<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">function getWords(strValue,flag)&#123;</div><div class="line"> //flag为true的时候，提取template部分简体中文，供替换使用</div><div class="line"> //flag为false的时候，提取全部简体中文，二者正则不同</div><div class="line">  var reg = flag? /\&quot;?([0-9a-zA-Z\u4e00-\u9fa5|\-|\s|\(|\)\:\：\、\，\,\！\!\。])+/g : /(([0-9a-zA-Z]+)?[\u4e00-\u9fa5|\-|\s|\(|\)\、\，\,\:\：\！\!\。\~]([0-9a-zA-Z]+)?)+/g</div><div class="line">  //匹配注释的正则，注释不用提取翻译，故提取前先移除</div><div class="line">  let regCommon = /(\/\/[\w\s\,\，\‘\(\)\—\:\：\=\&gt;\、\？\。a-zA-Z\.\u4e00-\u9fa5|\[|\]|-]*\n)|(\&lt;\!\-\-[\w\s\‘\-\、a-zA-Z\u4e00-\u9fa5|\[|\]|-]*\-\-\&gt;)|(\/\*[\w\‘\s\r\n\*\u4e00-\u9fa5|\-]*\*\/)/g</div><div class="line">  strValue = strValue.replace(regCommon, function(word) &#123; // 去除注释后的文本</div><div class="line">    return &apos;&apos;</div><div class="line">  &#125;);</div><div class="line">  //优化提取结果，去重，过滤，排序</div><div class="line">  let res = [...new Set(strValue.match(reg))].filter(item=&gt;&#123;return /([\u4e00-\u9fa5])+/g.test(item)&#125;).map(item=&gt;&#123;return item.trim()&#125;)</div><div class="line">  res = res.sort((a,b)=&gt;&#123;</div><div class="line">    return b.length-a.length</div><div class="line">  &#125;)</div><div class="line">  return res</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="去掉注释"><a href="#去掉注释" class="headerlink" title="去掉注释"></a>去掉注释</h3><p>本来想参考<a href="https://www.cnblogs.com/tugenhua0707/p/11332463.html" target="_blank" rel="external">webpack打包时去除注释的正则</a>，发现webpack去除注释，用的分词<br>直接通过判断astnode类型去判断是否为注释，然后根据配置决定保留去除<br>后来想起在阅读vue源码的时候有看到过在解析html的时候有形成注释类型的节点<br>所以从vue 源码中试图寻找注释的正则，发现vue也是只通过注释开头标志//，/** 或者&lt;!–<br>来判断注释开始，所以我在此基础上自己编写了解析注释的正则并将他们去除</p>
<h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><p>替换文本，用括号括起来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">function partTransfor(strValue)&#123;</div><div class="line">  let originData = strValue</div><div class="line">  let res = getWords(strValue,true) //拿到template部分简体中文</div><div class="line">  for(let str of res)&#123;</div><div class="line">    let placeholder = str.charAt(0) ===&apos;\&quot;&apos; </div><div class="line">    let temp = placeholder?str.substring(1):str</div><div class="line">    let reg1 = new RegExp(str,&apos;ig&apos;)</div><div class="line">    let reg2 = new RegExp(&quot;placeholder=\&quot;(&quot;+temp+&quot;)\&quot;&quot;,&apos;ig&apos;)</div><div class="line">    let reg = placeholder?reg2:reg1</div><div class="line">    originData = originData.replace(reg,function(word,str)&#123;</div><div class="line">      if(placeholder)&#123; //如果是placeholder部分的简体中文</div><div class="line">        return &apos;:placeholder=&quot;i18nTitle(\&apos;&apos;+str+&apos;\&apos;)&quot;&apos;</div><div class="line">      &#125;else&#123;</div><div class="line">        if(/[\u4e00-\u9fa5\:\&apos;]/.test(originData[str-1]) || /[\u4e00-\u9fa5\:\&apos;]/.test(originData[str+word]))&#123; //对于一些包含特殊字符连接的手动处理</div><div class="line">          return word</div><div class="line">        &#125;</div><div class="line">        return &apos;&#123;&#123;i18nTitle(\&apos;&apos;+word+&apos;\&apos;)&#125;&#125;&apos; //对于纯简体中文用函数包裹进行替换</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">  return originData</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实需要处理的情况分三种<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.js里面用this.i18nTitle(&apos;xxx&apos;)</div><div class="line">2.placeholder=&apos;xxx&apos;改成:placehoder=&quot;i18nTitle(&apos;xxxx&apos;)&quot;</div><div class="line">3.单纯标签的这种，&lt;label&gt;xxxx&lt;/label&gt;改成&lt;label&gt;&#123;&#123;i18nTitle(xxxx)&#125;&#125;&lt;/label&gt;</div></pre></td></tr></table></figure></p>
<p>另外涉及到组件里面的就直接在组件里需要展示的配置的中文简体字段变量外加全局函数</p>
<h2 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h2><p>每个文件提取处理好后，将所有字段合成一个文件，做去重处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">var fs = require(&apos;fs&apos;);</div><div class="line">var path = require(&apos;path&apos;);//解析需要遍历的文件夹</div><div class="line">var filePath = path.resolve(&apos;./words/js&apos;);</div><div class="line">var words = []</div><div class="line">const getFileOfDirSync = (dir) =&gt; &#123;</div><div class="line">  let files = fs.readdirSync(dir);</div><div class="line">  let result;</div><div class="line">  if (files) &#123;</div><div class="line">    result = files.map((file) =&gt; &#123;</div><div class="line">      let filePath = path.join(dir, file);</div><div class="line">      if (fs.statSync(filePath).isDirectory()) &#123;</div><div class="line">        return getFileOfDirSync(filePath); //递归</div><div class="line">      &#125; else &#123;</div><div class="line">        let content = fs.readFileSync(filePath, &apos;utf-8&apos;);</div><div class="line">        content = content.replace(&apos;export default&apos;,&apos;module.exports =&apos;) //更改模块编写方法</div><div class="line">        fs.writeFileSync(filePath,content);//方便读取</div><div class="line">        let data = require(filePath)</div><div class="line">        let keys = Object.keys(data)</div><div class="line">        let comment = content.substring(0,content.indexOf(&apos;module&apos;))</div><div class="line">        return keys;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">  return [... new Set(result.flat(Infinity))]; //数组摊平去重</div><div class="line">&#125;</div><div class="line">let res = getFileOfDirSync(filePath)</div><div class="line">res = res.sort((a,b)=&gt;&#123;</div><div class="line">  return b.length-a.length</div><div class="line">&#125;)</div><div class="line">let obj = &#123;&#125;</div><div class="line">res.map(item=&gt;&#123;obj[item]=&apos;&apos;&#125;)</div><div class="line">//res.map(item=&gt;&#123;obj[item]=item&#125;) //直接生成简体中文翻译文件</div><div class="line">let str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</div><div class="line">str = &apos;export default &apos;+ str</div><div class="line">fs.writeFile(&apos;./words/cnAll1.js&apos;, str,function(err)&#123;</div><div class="line">  if(err) console.log(&apos;提取操作失败&apos;);</div><div class="line">  else console.log(&apos;提取操作成功&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="翻译"><a href="#翻译" class="headerlink" title="翻译"></a>翻译</h2><p>根据简体中文和翻译结果形成翻译文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">let obj = &#123;&#125;</div><div class="line">let ll = &#123;&#125;</div><div class="line">let llkeys  = Object.keys(&#123; //翻译结果</div><div class="line">  &apos;建議選擇購買當前雲裸機已掛載使用的存儲類型和磁盤類型&apos;:&apos;&apos;,</div><div class="line">  &apos;超高端存儲：穩定性和安全性最好，適用於核心業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;高端存儲：穩定性和安全性較好，適用於重要業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;中端存儲：穩定性和安全性壹般，適用於壹般業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;普通存儲：穩定性和安全性較差，適用於邊緣業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;NVME：新壹代固態磁盤，性能最好、延時最低，適用於核心業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;SSD：固態磁盤，性能較好、延時較低，適用於重要業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;SAS：機械磁盤，性能壹般、延時壹般，適用於壹般業務系統&apos;:&apos;&apos;,</div><div class="line">  &apos;SATA：機械磁盤，性能較差、延時較高，適用於邊緣業務系統和歸檔數據&apos;:&apos;&apos;,</div><div class="line">&#125;)</div><div class="line">let objkeys = Object.keys(&#123; //简体中文</div><div class="line">  &apos;建议选择购买当前云裸机已挂载使用的存储类型和磁盘类型&apos;:&apos;&apos;,</div><div class="line">  &apos;超高端存储：稳定性和安全性最好，适用于核心业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;高端存储：稳定性和安全性较好，适用于重要业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;中端存储：稳定性和安全性一般，适用于一般业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;普通存储：稳定性和安全性较差，适用于边缘业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;NVME：新一代固态磁盘，性能最好、延时最低，适用于核心业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;SSD：固态磁盘，性能较好、延时较低，适用于重要业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;SAS：机械磁盘，性能一般、延时一般，适用于一般业务系统&apos;:&apos;&apos;,</div><div class="line">  &apos;SATA：机械磁盘，性能较差、延时较高，适用于边缘业务系统和归档数据&apos;:&apos;&apos;,</div><div class="line">&#125;)</div><div class="line">let tw = &#123;&#125;</div><div class="line">objkeys.map((item,i)=&gt;&#123;</div><div class="line">  tw[item] = llkeys[i] //生成繁体翻译文件</div><div class="line">  obj[item] = item //生成简体中文</div><div class="line">&#125;)</div><div class="line"></div><div class="line">let str = JSON.stringify(tw,&apos;&apos;,&quot;  &quot;)</div><div class="line">str = &apos;export default &apos;+ str</div><div class="line">fs.writeFile(&apos;zh-TW.js&apos;, str,function(err)&#123;</div><div class="line">  if(err) console.log(&apos;提取操作失败&apos;);</div><div class="line">  else console.log(&apos;提取操作成功&apos;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</div><div class="line">str = &apos;export default &apos;+ str</div><div class="line">fs.writeFile(&apos;zh-CN.js&apos;, str,function(err)&#123;</div><div class="line">  if(err) console.log(&apos;提取操作失败&apos;);</div><div class="line">  else console.log(&apos;提取操作成功&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>有新页面上新需要对新老字段进行差值处理，仅新增原来没有的字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">let data = require(&apos;./words/zh-CN&apos;)</div><div class="line">let keys = Object.keys(data) //老数据</div><div class="line">let dataNew = require(&apos;./words/cnAll1&apos;) </div><div class="line">let keysNew = Object.keys(dataNew)//新页面数据</div><div class="line">let obj = &#123;&#125;</div><div class="line">let newWords = keysNew.filter(newkey=&gt;&#123;</div><div class="line">   return !keys.includes(newkey)</div><div class="line">&#125;).map(item=&gt;&#123;</div><div class="line">  obj[item]=item</div><div class="line">  return item</div><div class="line">&#125;)//得到新增的文本</div><div class="line">let ll = &#123;&#125; //新增文本翻译结果</div><div class="line">let llkeys  = Object.keys(ll)</div><div class="line">let objkeys = Object.keys(obj)</div><div class="line">let tw = &#123;&#125;</div><div class="line">objkeys.map((item,i)=&gt;&#123;</div><div class="line">  tw[item] = llkeys[i]</div><div class="line">&#125;)</div><div class="line">//生成简体和繁体翻译文件，再复制粘贴到老文件中</div><div class="line">// let str = JSON.stringify(obj,&apos;&apos;,&quot;  &quot;)</div><div class="line">let str = JSON.stringify(tw,&apos;&apos;,&quot;  &quot;)</div><div class="line">str = &apos;export default &apos;+ str</div><div class="line">fs.writeFile(&apos;./words/compareResult3.js&apos;, str,function(err)&#123;</div><div class="line">  if(err) console.log(&apos;提取操作失败&apos;);</div><div class="line">  else console.log(&apos;提取操作成功&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><h2 id="其他云多语言切换"><a href="#其他云多语言切换" class="headerlink" title="其他云多语言切换"></a>其他云多语言切换</h2><p>阿里云：首先会根据不同域名产生对应不同语言的站点，站点画面风格可能不同，如日本<br>另外根据语言切换，还会在同一域名下通过切换URI产生不同语言广告页面（切换时，请求cookie中会携带语言类型，aliyun_lang）<br>广告页面和站点页面可能相同，如香港，台湾的繁体页面，<br>可能不同，如简体中文和日文的时候</p>
<p>腾讯云：站点只有两种：中国站和国际站，两种站点风格不同<br>多语言切换在国际站点里面进行，同样通过切换URI，切换不同语言<br>切换时直接在query里面携带语言信息（<a href="https://intl.cloud.tencent.com/jp/?lang=jp&amp;pg=）" target="_blank" rel="external">https://intl.cloud.tencent.com/jp/?lang=jp&amp;pg=）</a></p>
<p>平安云：只有两种语言切换，中文和英文，使用同一站点，<br>切换时通过在cookie里面携带需要的语言类型字段language，<br>获取相应语言的html和图片</p>
<h2 id="i18n大致原理"><a href="#i18n大致原理" class="headerlink" title="i18n大致原理"></a>i18n大致原理</h2><p>i18n 的翻译原理就是在vue.use挂载i18n后,在install阶段会挂载上$t全局函数<br>我们在使用$t的时候只是单纯传入待翻译的简体中文，<br>$t会再调用VUEI18N对象上的内部方法，将当前语言环境和语言库传入，<br>然后通过message[key]的形式找到对应的翻译值，返回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line">Vue.prototype.$t = function (key) &#123;</div><div class="line">  var values = [], len = arguments.length - 1;</div><div class="line">  while ( len-- &gt; 0 ) values[ len ] = arguments[ len + 1 ];</div><div class="line"></div><div class="line">  var i18n = this.$i18n;</div><div class="line">  return i18n._t.apply(i18n, [ key, i18n.locale, i18n._getMessages(), this ].concat( values ))</div><div class="line">&#125;;</div><div class="line"></div><div class="line">VueI18n.prototype._getMessages = function _getMessages () &#123; return this._vm.messages &#125;;</div><div class="line"></div><div class="line">//this._vm.messages 值生成</div><div class="line">VueI18n.prototype.setLocaleMessage = function setLocaleMessage (locale, message) &#123;</div><div class="line">  if (this._warnHtmlInMessage === &apos;warn&apos; || this._warnHtmlInMessage === &apos;error&apos;) &#123;</div><div class="line">    this._checkLocaleMessage(locale, this._warnHtmlInMessage, message);</div><div class="line">  &#125;</div><div class="line">  this._vm.$set(this._vm.messages, locale, message);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">VueI18n.prototype.mergeLocaleMessage = function mergeLocaleMessage (locale, message) &#123;</div><div class="line">  if (this._warnHtmlInMessage === &apos;warn&apos; || this._warnHtmlInMessage === &apos;error&apos;) &#123;</div><div class="line">    this._checkLocaleMessage(locale, this._warnHtmlInMessage, message);</div><div class="line">  &#125;</div><div class="line">  this._vm.$set(this._vm.messages, locale, merge(&#123;&#125;, this._vm.messages[locale] || &#123;&#125;, message));</div><div class="line">&#125;;</div><div class="line"></div><div class="line">VueI18n.prototype._t = function _t (key, _locale, messages, host) &#123;</div><div class="line">    var ref;</div><div class="line"></div><div class="line">    var values = [], len = arguments.length - 4;</div><div class="line">    while ( len-- &gt; 0 ) values[ len ] = arguments[ len + 4 ];</div><div class="line">  if (!key) &#123; return &apos;&apos; &#125;</div><div class="line"></div><div class="line">  var parsedArgs = parseArgs.apply(void 0, values);</div><div class="line">  var locale = parsedArgs.locale || _locale;</div><div class="line"></div><div class="line">  var ret = this._translate(</div><div class="line">    messages, locale, this.fallbackLocale, key,</div><div class="line">    host, &apos;string&apos;, parsedArgs.params</div><div class="line">  );</div><div class="line">  if (this._isFallbackRoot(ret)) &#123;</div><div class="line">    if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallbackWarn(key)) &#123;</div><div class="line">      warn((&quot;Fall back to translate the keypath &apos;&quot; + key + &quot;&apos; with root locale.&quot;));</div><div class="line">    &#125;</div><div class="line">    /* istanbul ignore if */</div><div class="line">    if (!this._root) &#123; throw Error(&apos;unexpected error&apos;) &#125;</div><div class="line">    return (ref = this._root).$t.apply(ref, [ key ].concat( values ))</div><div class="line">  &#125; else &#123;</div><div class="line">    ret = this._warnDefault(locale, key, ret, host, values, &apos;string&apos;);</div><div class="line">    if (this._postTranslation) &#123;</div><div class="line">      ret = this._postTranslation(ret);</div><div class="line">    &#125;</div><div class="line">    return ret</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">VueI18n.prototype._translate = function _translate (</div><div class="line">  messages,</div><div class="line">  locale,</div><div class="line">  fallback,</div><div class="line">  key,</div><div class="line">  host,</div><div class="line">  interpolateMode,</div><div class="line">  args</div><div class="line">) &#123; </div><div class="line">  //messages[locale] 拿到语言库</div><div class="line">  var res =</div><div class="line">    this._interpolate(locale, messages[locale], key, host, interpolateMode, args, [key]);</div><div class="line">  if (!isNull(res)) &#123; return res &#125;</div><div class="line"></div><div class="line">  res = this._interpolate(fallback, messages[fallback], key, host, interpolateMode, args, [key]);</div><div class="line">  if (!isNull(res)) &#123;</div><div class="line">    if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallbackWarn(key)) &#123;</div><div class="line">      warn((&quot;Fall back to translate the keypath &apos;&quot; + key + &quot;&apos; with &apos;&quot; + fallback + &quot;&apos; locale.&quot;));</div><div class="line">    &#125;</div><div class="line">    return res</div><div class="line">  &#125; else &#123;</div><div class="line">    return null</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">VueI18n.prototype._interpolate = function _interpolate (</div><div class="line">  locale,</div><div class="line">  message,</div><div class="line">  key,</div><div class="line">  host,</div><div class="line">  interpolateMode,</div><div class="line">  values,</div><div class="line">  visitedLinkStack</div><div class="line">) &#123;</div><div class="line">  if (!message) &#123; return null &#125;</div><div class="line"></div><div class="line">  var pathRet = this._path.getPathValue(message, key);</div><div class="line">  if (Array.isArray(pathRet) || isPlainObject(pathRet)) &#123; return pathRet &#125;</div><div class="line"></div><div class="line">  var ret;</div><div class="line">  if (isNull(pathRet)) &#123;</div><div class="line">    /* istanbul ignore else */</div><div class="line">    if (isPlainObject(message)) &#123;</div><div class="line">      ret = message[key]; //从语言库里面拿到对应翻译值</div><div class="line">      if (typeof ret !== &apos;string&apos;) &#123;</div><div class="line">        if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallback(locale, key)) &#123;</div><div class="line">          warn((&quot;Value of key &apos;&quot; + key + &quot;&apos; is not a string!&quot;));</div><div class="line">        &#125;</div><div class="line">        return null</div><div class="line">      &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">      return null</div><div class="line">    &#125;</div><div class="line">  &#125; else &#123;</div><div class="line">    /* istanbul ignore else */</div><div class="line">    if (typeof pathRet === &apos;string&apos;) &#123;</div><div class="line">      ret = pathRet;</div><div class="line">    &#125; else &#123;</div><div class="line">      if (!this._isSilentTranslationWarn(key) &amp;&amp; !this._isSilentFallback(locale, key)) &#123;</div><div class="line">        warn((&quot;Value of key &apos;&quot; + key + &quot;&apos; is not a string!&quot;));</div><div class="line">      &#125;</div><div class="line">      return null</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  // Check for the existence of links within the translated string</div><div class="line">  if (ret.indexOf(&apos;@:&apos;) &gt;= 0 || ret.indexOf(&apos;@.&apos;) &gt;= 0) &#123;</div><div class="line">    ret = this._link(locale, message, ret, host, &apos;raw&apos;, values, visitedLinkStack);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return this._render(ret, interpolateMode, values, key)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">VueI18n.prototype._render = function _render (message, interpolateMode, values, path) &#123;</div><div class="line">  var ret = this._formatter.interpolate(message, values, path);</div><div class="line">  // If the custom formatter refuses to work - apply the default one</div><div class="line">  if (!ret) &#123;</div><div class="line">    ret = defaultFormatter.interpolate(message, values, path);</div><div class="line">  &#125;</div><div class="line">  // if interpolateMode is **not** &apos;string&apos; (&apos;row&apos;),</div><div class="line">  // return the compiled data (e.g. [&apos;foo&apos;, VNode, &apos;bar&apos;]) with formatter</div><div class="line">  return interpolateMode === &apos;string&apos; &amp;&amp; typeof ret !== &apos;string&apos; ? ret.join(&apos;&apos;) : ret</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/nodejs/middlwareSrc.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/nodejs/middlwareSrc.html" itemprop="url">
                  KOA框架剥洋葱原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-24T17:18:37+08:00">
                2020-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="收集"><a href="#收集" class="headerlink" title="收集"></a>收集</h1><p>new 一个koa实例后，调用use接口会将传入的中间件函数push到middleware属性数组中做收集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">application.js</div><div class="line"></div><div class="line">use(fn) &#123;</div><div class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;middleware must be a function!&apos;);</div><div class="line">    if (isGeneratorFunction(fn)) &#123;</div><div class="line">      deprecate(&apos;Support for generators will be removed in v3. &apos; +</div><div class="line">                &apos;See the documentation for examples of how to convert old middleware &apos; +</div><div class="line">                &apos;https://github.com/koajs/koa/blob/master/docs/migration.md&apos;);</div><div class="line">      fn = convert(fn);</div><div class="line">    &#125;</div><div class="line">    debug(&apos;use %s&apos;, fn._name || fn.name || &apos;-&apos;);</div><div class="line">    this.middleware.push(fn);</div><div class="line">    return this;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>根据koa框架版本不同，需要将使用generator函数写的中间件转化成基于promise的函数形式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">const convert = require(&apos;koa-convert&apos;);</div><div class="line"></div><div class="line">function convert (mw) &#123;</div><div class="line">  if (typeof mw !== &apos;function&apos;) &#123;</div><div class="line">    throw new TypeError(&apos;middleware must be a function&apos;)</div><div class="line">  &#125;</div><div class="line">  //再次确认是否是generator函数</div><div class="line">  if (mw.constructor.name !== &apos;GeneratorFunction&apos;) &#123;</div><div class="line">    // 假设它是一个基于promise的中间件</div><div class="line">    // 就直接返回</div><div class="line">    return mw</div><div class="line">  &#125;</div><div class="line">  //如果是generator函数就转换成promise形式</div><div class="line">  const converted = function (ctx, next) &#123;</div><div class="line">    return co.call(ctx, mw.call(ctx, createGenerator(next)))</div><div class="line">  &#125;</div><div class="line">  converted._name = mw._name || mw.name</div><div class="line">  return converted</div><div class="line">&#125;</div><div class="line"></div><div class="line">const co = require(&apos;co&apos;)</div><div class="line"></div><div class="line">function co(gen) &#123;</div><div class="line">  var ctx = this;</div><div class="line">  var args = slice.call(arguments, 1)</div><div class="line"></div><div class="line">  // we wrap everything in a promise to avoid promise chaining,</div><div class="line">  // which leads to memory leak errors.</div><div class="line">  // see https://github.com/tj/co/issues/180</div><div class="line">  return new Promise(function(resolve, reject) &#123;</div><div class="line">    if (typeof gen === &apos;function&apos;) gen = gen.apply(ctx, args);</div><div class="line">    if (!gen || typeof gen.next !== &apos;function&apos;) return resolve(gen);</div><div class="line"></div><div class="line">    onFulfilled();</div><div class="line"></div><div class="line">    /**</div><div class="line">     * @param &#123;Mixed&#125; res</div><div class="line">     * @return &#123;Promise&#125;</div><div class="line">     * @api private</div><div class="line">     */</div><div class="line"></div><div class="line">    function onFulfilled(res) &#123;</div><div class="line">      var ret;</div><div class="line">      try &#123;</div><div class="line">        ret = gen.next(res);</div><div class="line">      &#125; catch (e) &#123;</div><div class="line">        return reject(e);</div><div class="line">      &#125;</div><div class="line">      next(ret);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * @param &#123;Error&#125; err</div><div class="line">     * @return &#123;Promise&#125;</div><div class="line">     * @api private</div><div class="line">     */</div><div class="line"></div><div class="line">    function onRejected(err) &#123;</div><div class="line">      var ret;</div><div class="line">      try &#123;</div><div class="line">        ret = gen.throw(err);</div><div class="line">      &#125; catch (e) &#123;</div><div class="line">        return reject(e);</div><div class="line">      &#125;</div><div class="line">      next(ret);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Get the next value in the generator,</div><div class="line">     * return a promise.</div><div class="line">     *</div><div class="line">     * @param &#123;Object&#125; ret</div><div class="line">     * @return &#123;Promise&#125;</div><div class="line">     * @api private</div><div class="line">     */</div><div class="line"></div><div class="line">    function next(ret) &#123;</div><div class="line">      if (ret.done) return resolve(ret.value);</div><div class="line">      var value = toPromise.call(ctx, ret.value);</div><div class="line">      if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);</div><div class="line">      return onRejected(new TypeError(&apos;You may only yield a function, promise, generator, array, or object, &apos;</div><div class="line">        + &apos;but the following object was passed: &quot;&apos; + String(ret.value) + &apos;&quot;&apos;));</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h1><p>调用listen函数开启服务时，整合所有中间件为一个大函数，大函数中进行剥洋葱流程<br>在收到请求时调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">application.js</div><div class="line"></div><div class="line">listen(...args) &#123;</div><div class="line">  debug(&apos;listen&apos;);</div><div class="line">  const server = http.createServer(this.callback());</div><div class="line">  return server.listen(...args);</div><div class="line">&#125;</div><div class="line"></div><div class="line">callback() &#123;</div><div class="line">  const fn = compose(this.middleware); //整合中间件</div><div class="line"></div><div class="line">  if (!this.listenerCount(&apos;error&apos;)) this.on(&apos;error&apos;, this.onerror);</div><div class="line"></div><div class="line">  const handleRequest = (req, res) =&gt; &#123;</div><div class="line">    const ctx = this.createContext(req, res);</div><div class="line">    return this.handleRequest(ctx, fn); //调用中间件</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  return handleRequest;</div><div class="line">&#125;</div><div class="line"></div><div class="line">handleRequest(ctx, fnMiddleware) &#123;</div><div class="line">  //通过传递过来的ctx,获取到原生的可写流</div><div class="line">  const res = ctx.res;</div><div class="line">  //设置默认状态码</div><div class="line">  res.statusCode = 404;</div><div class="line">  const onerror = err =&gt; ctx.onerror(err);</div><div class="line">  const handleResponse = () =&gt; respond(ctx);</div><div class="line">  onFinished(res, onerror);</div><div class="line">  //调用中间件大函数 同时准备catch处理中间件级错误</div><div class="line">  return fnMiddleware(ctx).then(handleResponse).catch(onerror); </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>整合中间件 ，返回大函数，大函数中有剥洋葱模型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">function compose (middleware) &#123;</div><div class="line">  if (!Array.isArray(middleware)) throw new TypeError(&apos;Middleware stack must be an array!&apos;)</div><div class="line">  for (const fn of middleware) &#123;</div><div class="line">    if (typeof fn !== &apos;function&apos;) throw new TypeError(&apos;Middleware must be composed of functions!&apos;)</div><div class="line">  &#125;</div><div class="line">  //调用时fnMiddleware(ctx).then(handleResponse).catch(onerror); </div><div class="line">  //next 是undefined</div><div class="line">  return function (context, next) &#123;</div><div class="line">    // last called middleware #</div><div class="line">    let index = -1</div><div class="line">    return dispatch(0)</div><div class="line">    function dispatch (i) &#123;</div><div class="line">      if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</div><div class="line">      index = i</div><div class="line">      let fn = middleware[i]</div><div class="line">      if (i === middleware.length) fn = next</div><div class="line">      if (!fn) return Promise.resolve()</div><div class="line">      try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</div><div class="line">        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</div><div class="line">      &#125; catch (err) &#123;</div><div class="line">        return Promise.reject(err)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="剥洋葱流程"><a href="#剥洋葱流程" class="headerlink" title="剥洋葱流程"></a>剥洋葱流程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">let index = -1</div><div class="line">return dispatch(0) //从第一个中间件开始执行</div><div class="line">function dispatch (i) &#123;</div><div class="line">  //防止next 在一个中间件中被调用多次</div><div class="line">  if (i &lt;= index) return Promise.reject(new Error(&apos;next() called multiple times&apos;))</div><div class="line">  index = i</div><div class="line">  let fn = middleware[i] //拿到中间件</div><div class="line">  if (i === middleware.length) fn = next //如果中间件函数全部调用完，fn 赋值为next,next为undefined</div><div class="line">  if (!fn) return Promise.resolve() //fn为next=&gt;undefined时成立，即执行到最后返回一个Promise.resolve() 可以继续写then</div><div class="line">  try &#123;//try-catch 用于保证错误在promise的情况能够正常捕获</div><div class="line">    //执行中间件函数，传入ctx,next参数，next即dispatch.bind(null, i + 1)，</div><div class="line">    //递归调用下一个中间件函数</div><div class="line">    //从这一步可以实现await next()时，先执行下一个中间件函数</div><div class="line">    //中间件有调用next,就利用await暂停当前中间件执行，开始执行下一个中间件</div><div class="line">    return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));</div><div class="line">  &#125; catch (err) &#123;</div><div class="line">    return Promise.reject(err)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>利用await暂停当前中间件执行，调用next开始执行下一个中间件</p>
<p>如果下一个中间件没有调next,且不是最后一个中间件，<br>即不会再调用dispatch执行下下一个中间件，则后续中间件都不会被执行到</p>
<p>如果下一个中间件是最后一个中间件，且在其中调用了next,则不会走到这个流程，<br>在上面的流程中就return</p>
<p>如果下一个中间件是最后一个中间件,则执行完return Promise.resolve<br>上一个中间件await 拿到结果后继续执行await后面的代码<br>执行完await后面代码后，上上一个中间件await 拿到结果，继续执行当前中间件await后代码<br>依次类推，直到第一个中间件await后代码执行完毕，整个中间件流程，<br>即剥洋葱流程先内层后外层执行流程完毕<br>返回promise 接着then处理响应或者中间有错误捕获错误<br>fnMiddleware(ctx).then(handleResponse).catch(onerror)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuex2.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuex2.html" itemprop="url">
                  vuex 源码学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-27T07:46:15+08:00">
                2020-04-27
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">let moduleA = &#123;</div><div class="line">  namespaced: true,</div><div class="line">  state()&#123; </div><div class="line">    return&#123;</div><div class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  getters:&#123;</div><div class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/aa/getCount&apos;] 作为b子模块时</div><div class="line">      console.log(args)</div><div class="line">      return  &apos;this is a getter~~~~~&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </div><div class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </div><div class="line">      state.counta++</div><div class="line">    &#125;,</div><div class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</div><div class="line">      state.counta++</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">let moduleB = &#123;</div><div class="line">  namespaced: true,</div><div class="line">  state: &#123; </div><div class="line">    countb: 0,//this.$store.state.b.countb</div><div class="line">  &#125;,</div><div class="line">  getters:&#123;</div><div class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/getCount&apos;] 因为设置了namespaced所以可以重名</div><div class="line">      console.log(args)</div><div class="line">      return  &apos;this is a getter~~~~~&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</div><div class="line">      state.countb++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</div><div class="line">    aa: moduleA,//this.$store.state.b.aa.counta</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">// vuex相关代码</div><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123; </div><div class="line">    count: 0, //this.$store.state.count</div><div class="line">  &#125;,</div><div class="line">  getters:&#123;</div><div class="line">    getCount(...args)&#123; //this.$store.getters.getCount</div><div class="line">      console.log(args)</div><div class="line">      return  &apos;this is a getter&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</div><div class="line">      state.count++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  modules: &#123;</div><div class="line">    a: moduleA, //this.$store.state.a.counta</div><div class="line">    b: moduleB //this.$store.state.b.countb</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>以上面store结构为例，分析vuex源码</p>
<h1 id="new-Store"><a href="#new-Store" class="headerlink" title="new Store"></a>new Store</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">var Store = function Store (options) &#123;</div><div class="line">   var this$1 = this;</div><div class="line">   if ( options === void 0 ) options = &#123;&#125;;</div><div class="line">   if (!Vue &amp;&amp; typeof window !== &apos;undefined&apos; &amp;&amp; window.Vue) &#123;</div><div class="line">     install(window.Vue);</div><div class="line">   &#125;</div><div class="line">   var plugins = options.plugins; if ( plugins === void 0 ) plugins = [];</div><div class="line">   var strict = options.strict; if ( strict === void 0 ) strict = false;</div><div class="line"></div><div class="line">   // 一些内部参数</div><div class="line">   this._committing = false;</div><div class="line">   this._actions = Object.create(null);</div><div class="line">   this._actionSubscribers = [];</div><div class="line">   this._mutations = Object.create(null);</div><div class="line">   this._wrappedGetters = Object.create(null);</div><div class="line">   this._modules = new ModuleCollection(options);</div><div class="line">   this._modulesNamespaceMap = Object.create(null);</div><div class="line">   this._subscribers = [];</div><div class="line">   this._watcherVM = new Vue();</div><div class="line">   this._makeLocalGettersCache = Object.create(null);</div><div class="line"></div><div class="line">   //绑定 commit 和 dispatch 的执行对象始终指向自己，防止外界重新绑定</div><div class="line">   var store = this;</div><div class="line">   var ref = this;</div><div class="line">   var dispatch = ref.dispatch;</div><div class="line">   var commit = ref.commit;</div><div class="line">   this.dispatch = function boundDispatch (type, payload) &#123;</div><div class="line">     return dispatch.call(store, type, payload)</div><div class="line">   &#125;;</div><div class="line">   this.commit = function boundCommit (type, payload, options) &#123;</div><div class="line">     return commit.call(store, type, payload, options)</div><div class="line">   &#125;;</div><div class="line"></div><div class="line">   // 严格模式</div><div class="line">   //使 Vuex store 进入严格模式，在严格模式下，任何 mutation 处理函数以外修改 Vuex state 都会抛出错误。</div><div class="line">   this.strict = strict;</div><div class="line">   //拿到处理后的state</div><div class="line">   var state = this._modules.root.state;</div><div class="line"></div><div class="line">   // 初始化全局module</div><div class="line">   // 同时递归注册所有子模块</div><div class="line">   // 收集this._wrappedGetters中的所有模块的getters</div><div class="line">   installModule(this, state, [], this._modules.root);</div><div class="line"></div><div class="line">   // 初始化store vm, 用于数据响应</div><div class="line">   // 同时注册 _wrappedGetters 作为计算属性)</div><div class="line">   resetStoreVM(this, state);</div><div class="line"></div><div class="line">   // 使用插件处理</div><div class="line">   plugins.forEach(function (plugin) &#123; return plugin(this$1); &#125;);</div><div class="line">   //options.devtools为某个特定的 Vuex 实例打开或关闭 devtools。</div><div class="line">   //对于传入 false 的实例来说 Vuex store 不会订阅到 devtools 插件。可用于一个页面中有多个 store 的情况</div><div class="line">   var useDevtools = options.devtools !== undefined ? options.devtools : Vue.config.devtools;</div><div class="line">   if (useDevtools) &#123;</div><div class="line">     devtoolPlugin(this);</div><div class="line">   &#125;</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<h1 id="install"><a href="#install" class="headerlink" title="install"></a>install</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">function install (_Vue) &#123;</div><div class="line">  if (Vue &amp;&amp; _Vue === Vue) &#123;</div><div class="line">    //Vue.use(Vuex) should be called only once</div><div class="line">    return</div><div class="line">  &#125;</div><div class="line">  Vue = _Vue;</div><div class="line">  applyMixin(Vue);</div><div class="line">&#125;</div><div class="line">function applyMixin (Vue) &#123;</div><div class="line">  var version = Number(Vue.version.split(&apos;.&apos;)[0]);</div><div class="line"></div><div class="line">  if (version &gt;= 2) &#123;</div><div class="line">    Vue.mixin(&#123; beforeCreate: vuexInit &#125;); //使用beforeCreate将$store绑定到每个VueComponent 上</div><div class="line">  &#125; else &#123;</div><div class="line">    //小于版本2的用_init初始化</div><div class="line">    var _init = Vue.prototype._init;</div><div class="line">    Vue.prototype._init = function (options) &#123;</div><div class="line">      if ( options === void 0 ) options = &#123;&#125;;</div><div class="line"></div><div class="line">      options.init = options.init</div><div class="line">        ? [vuexInit].concat(options.init)</div><div class="line">        : vuexInit;</div><div class="line">      _init.call(this, options);</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function vuexInit () &#123;</div><div class="line">    var options = this.$options;</div><div class="line">    // store injection</div><div class="line">    if (options.store) &#123;</div><div class="line">      this.$store = typeof options.store === &apos;function&apos;</div><div class="line">        ? options.store()</div><div class="line">        : options.store;</div><div class="line">    &#125; else if (options.parent &amp;&amp; options.parent.$store) &#123;</div><div class="line">      this.$store = options.parent.$store; //当前组件$store指向父组件$store，递归指向，从而保证唯一性</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="ModuleCollection"><a href="#ModuleCollection" class="headerlink" title="ModuleCollection"></a>ModuleCollection</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">var ModuleCollection = function ModuleCollection (rawRootModule) &#123;</div><div class="line">    // 根据new Store 传入的参数，注册根模块</div><div class="line">    this.register([], rawRootModule, false);</div><div class="line">  &#125;;</div><div class="line">  // new store 时传入的参数 [], rawRootModule, false</div><div class="line">  ModuleCollection.prototype.register = function register (path, rawModule, runtime) &#123;</div><div class="line">    var this$1 = this;</div><div class="line">    if ( runtime === void 0 ) runtime = true;</div><div class="line">    var newModule = new Module(rawModule, runtime);</div><div class="line">    //&#123;runtime:false,_children:&#123;&#125;,_rawModule:rawModule,state:rawModule上面的state,__proto__:一系列方法&#125;</div><div class="line">    if (path.length === 0) &#123;</div><div class="line">      this.root = newModule; //初始化根模块</div><div class="line">    &#125; else &#123; //初始化子模块</div><div class="line">      var parent = this.get(path.slice(0, -1)); //拿到父模块</div><div class="line">      parent.addChild(path[path.length - 1], newModule); //给父模块_children属性增加子模块</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 注册嵌套模块</div><div class="line">    if (rawModule.modules) &#123;</div><div class="line">      forEachValue(rawModule.modules, function (rawChildModule, key) &#123;</div><div class="line">        this$1.register(path.concat(key), rawChildModule, runtime); //递归注册</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">var Module = function Module (rawModule, runtime) &#123;</div><div class="line">  this.runtime = runtime;</div><div class="line">  // Store some children item</div><div class="line">  this._children = Object.create(null);</div><div class="line">  // Store the origin module object which passed by programmer</div><div class="line">  this._rawModule = rawModule;</div><div class="line">  var rawState = rawModule.state;</div><div class="line"></div><div class="line">  // Store the origin module&apos;s state</div><div class="line">  this.state = (typeof rawState === &apos;function&apos; ? rawState() : rawState) || &#123;&#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Module.prototype.addChild = function addChild (key, module) &#123;</div><div class="line">  this._children[key] = module;</div><div class="line">&#125;;</div><div class="line">Module.prototype.getChild = function getChild (key) &#123;</div><div class="line">  return this._children[key]</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>  所以这一步结束后<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this._modules = new ModuleCollection(options);</div></pre></td></tr></table></figure></p>
<p>  this._modules为如下对象<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ModuleCollection &#123;</div><div class="line">  root: Module &#123;</div><div class="line">    runtime: false,</div><div class="line">    _children: &#123;a: Module, b: Module&#125;</div><div class="line">    _rawModule: &#123;state: &#123;…&#125;, mutations: &#123;…&#125;, modules: &#123;…&#125;&#125;</div><div class="line">    state: &#123;count: 0&#125;</div><div class="line">    __proto__: Object</div><div class="line">  &#125;</div><div class="line">  __proto__: Object</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>  ModuleCollection对象上的其他方法<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ModuleCollection.prototype.get = function get (path) &#123;</div><div class="line">  return path.reduce(function (module, key) &#123;</div><div class="line">    return module.getChild(key)</div><div class="line">  &#125;, this.root)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">ModuleCollection.prototype.getNamespace = function getNamespace (path) &#123;</div><div class="line">  var module = this.root;</div><div class="line">  //对设置了namespaced的模块进行拼接</div><div class="line">  return path.reduce(function (namespace, key) &#123;</div><div class="line">    module = module.getChild(key); //从_children取出子模块</div><div class="line">    return namespace + (module.namespaced ? key + &apos;/&apos; : &apos;&apos;)</div><div class="line">  &#125;, &apos;&apos;)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">ModuleCollection.prototype.update = function update$1 (rawRootModule) &#123;</div><div class="line">  update([], this.root, rawRootModule);</div><div class="line">&#125;;</div><div class="line">ModuleCollection.prototype.unregister = function unregister (path) &#123;</div><div class="line">  var parent = this.get(path.slice(0, -1));</div><div class="line">  var key = path[path.length - 1];</div><div class="line">  if (!parent.getChild(key).runtime) &#123; return &#125;</div><div class="line"></div><div class="line">  parent.removeChild(key);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h1 id="installModule"><a href="#installModule" class="headerlink" title="installModule"></a>installModule</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">//初始化调用时传参 （this, state, [], this._modules.root)</div><div class="line">function installModule (store, rootState, path, module, hot) &#123;</div><div class="line">  //根模块时，参数分别为store本身，根模块state, [], 根模块，undefined</div><div class="line">  //递归子模块时，参数为 store本身，根模块state,子模块在modules对象中的路径key值</div><div class="line">  var isRoot = !path.length; //空数组即根模块</div><div class="line">  //ModuleCollection.prototype.getNamespace 根模块返回空字符串&apos;&apos;</div><div class="line">  var namespace = store._modules.getNamespace(path); </div><div class="line"></div><div class="line">  //如果模块设置了命名空间 在store._modulesNamespaceMap属性中注册</div><div class="line">  if (module.namespaced) &#123;</div><div class="line">    if (store._modulesNamespaceMap[namespace] &amp;&amp; &quot;development&quot; !== &apos;production&apos;) &#123;</div><div class="line">      console.error((&quot;[vuex] duplicate namespace &quot; + namespace + &quot; for the namespaced module &quot; + (path.join(&apos;/&apos;))));</div><div class="line">    &#125;</div><div class="line">    store._modulesNamespaceMap[namespace] = module;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  //对子模块state进行数据劫持处理</div><div class="line">  if (!isRoot &amp;&amp; !hot) &#123;</div><div class="line">    var parentState = getNestedState(rootState, path.slice(0, -1));</div><div class="line">    var moduleName = path[path.length - 1];</div><div class="line">    store._withCommit(function () &#123;</div><div class="line">      &#123;</div><div class="line">        if (moduleName in parentState) &#123;</div><div class="line">          console.warn(</div><div class="line">            (&quot;[vuex] state field \&quot;&quot; + moduleName + &quot;\&quot; was overridden by a module with the same name at \&quot;&quot; + (path.join(&apos;.&apos;)) + &quot;\&quot;&quot;)</div><div class="line">          );</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      Vue.set(parentState, moduleName, module.state); //将子模块state按照模块名添加到父模块state中</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">  //根据有无namespace</div><div class="line">  //截取state,getter的get,</div><div class="line">  //封装触发函数dispactch和commit,有namespace拼接后再触发</div><div class="line">  var local = module.context = makeLocalContext(store, namespace, path);</div><div class="line"></div><div class="line">  module.forEachMutation(function (mutation, key) &#123;</div><div class="line">    var namespacedType = namespace + key;</div><div class="line">    registerMutation(store, namespacedType, mutation, local);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  module.forEachAction(function (action, key) &#123;</div><div class="line">    var type = action.root ? key : namespace + key;</div><div class="line">    var handler = action.handler || action;</div><div class="line">    registerAction(store, type, handler, local);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  module.forEachGetter(function (getter, key) &#123;</div><div class="line">    var namespacedType = namespace + key;</div><div class="line">    registerGetter(store, namespacedType, getter, local);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  module.forEachChild(function (child, key) &#123;</div><div class="line">    installModule(store, rootState, path.concat(key), child, hot);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="forEachValue"><a href="#forEachValue" class="headerlink" title="forEachValue"></a>forEachValue</h2><p>公共方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">function forEachValue (obj, fn) &#123;</div><div class="line">   Object.keys(obj).forEach(function (key) &#123; return fn(obj[key], key); &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h2 id="注册-Mutation"><a href="#注册-Mutation" class="headerlink" title="注册 Mutation"></a>注册 Mutation</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Module.prototype.forEachMutation = function forEachMutation (fn) &#123;</div><div class="line">  if (this._rawModule.mutations) &#123;</div><div class="line">    forEachValue(this._rawModule.mutations, fn);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">//参数：store本身，经过namespace拼接后的类型标记，具体对应的mutation,当前模块上封装好的state,getters,commit,dispatch</div><div class="line">function registerMutation (store, type, handler, local) &#123;</div><div class="line">  var entry = store._mutations[type] || (store._mutations[type] = []);</div><div class="line">  entry.push(function wrappedMutationHandler (payload) &#123;</div><div class="line">    handler.call(store, local.state, payload);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>小结：将当前模块的mutations上的各个mutations结合namespace存储到store._mutations属性上<br>可见，如果子模块没有namespace,同名的mutation会跟根模块的mutation存储在相同的type下面<br>所以当触发commit的时候会一起执行，<br>如果子模块设置了namespace，这时存储的type会包含该模块对应的名称，<br>即使同名的mutation也被存放在不同的type中，实现了隔离</p>
<h2 id="注册-Action"><a href="#注册-Action" class="headerlink" title="注册 Action"></a>注册 Action</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">Module.prototype.forEachAction = function forEachAction (fn) &#123;</div><div class="line">  if (this._rawModule.actions) &#123;</div><div class="line">    forEachValue(this._rawModule.actions, fn);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">function registerAction (store, type, handler, local) &#123;</div><div class="line">  var entry = store._actions[type] || (store._actions[type] = []);</div><div class="line">  entry.push(function wrappedActionHandler (payload) &#123;</div><div class="line">    var res = handler.call(store, &#123;</div><div class="line">      dispatch: local.dispatch,</div><div class="line">      commit: local.commit,</div><div class="line">      getters: local.getters,</div><div class="line">      state: local.state,</div><div class="line">      rootGetters: store.getters,</div><div class="line">      rootState: store.state</div><div class="line">    &#125;, payload);</div><div class="line">    if (!isPromise(res)) &#123;</div><div class="line">      res = Promise.resolve(res);</div><div class="line">    &#125;</div><div class="line">    if (store._devtoolHook) &#123;</div><div class="line">      return res.catch(function (err) &#123;</div><div class="line">        store._devtoolHook.emit(&apos;vuex:error&apos;, err);</div><div class="line">        throw err</div><div class="line">      &#125;)</div><div class="line">    &#125; else &#123;</div><div class="line">      return res</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>小结：将当前模块的actions上的各个action结合namespace存储到store._actions属性上</p>
<h2 id="注册-Getter"><a href="#注册-Getter" class="headerlink" title="注册 Getter"></a>注册 Getter</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">Module.prototype.forEachGetter = function forEachGetter (fn) &#123;</div><div class="line">  if (this._rawModule.getters) &#123;</div><div class="line">    forEachValue(this._rawModule.getters, fn);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">function registerGetter (store, type, rawGetter, local) &#123;</div><div class="line">  if (store._wrappedGetters[type]) &#123;</div><div class="line">    &#123;</div><div class="line">      console.error((&quot;[vuex] duplicate getter key: &quot; + type));</div><div class="line">    &#125;</div><div class="line">    return</div><div class="line">  &#125;</div><div class="line">  store._wrappedGetters[type] = function wrappedGetter (store) &#123;</div><div class="line">    return rawGetter(</div><div class="line">      local.state, // 当前模块state</div><div class="line">      local.getters, // 当前模块 getters</div><div class="line">      store.state, // 根模块 state</div><div class="line">      store.getters // 根模块 getters</div><div class="line">    )</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>小结：将当前模块的getters上的各个getter结合namespace存储到store._wrappedGetters属性上</p>
<h2 id="注册-Module"><a href="#注册-Module" class="headerlink" title="注册 Module"></a>注册 Module</h2><p>递归调用installModule注册子模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Module.prototype.forEachChild = function forEachChild (fn) &#123;</div><div class="line">  forEachValue(this._children, fn);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">module.forEachChild(function (child, key) &#123;</div><div class="line">  installModule(store, rootState, path.concat(key), child, hot);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="makeLocalContext"><a href="#makeLocalContext" class="headerlink" title="makeLocalContext"></a>makeLocalContext</h2><p>优化 dispatch, commit, getters and state<br>如果没有设置namespace, 就使用根模块的名称<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">  function makeLocalContext (store, namespace, path) &#123;</div><div class="line">    var noNamespace = namespace === &apos;&apos;;</div><div class="line"></div><div class="line">    var local = &#123;</div><div class="line">      dispatch: noNamespace ? store.dispatch : function (_type, _payload, _options) &#123;</div><div class="line">        var args = unifyObjectStyle(_type, _payload, _options);</div><div class="line">        var payload = args.payload;</div><div class="line">        var options = args.options;</div><div class="line">        var type = args.type;</div><div class="line"></div><div class="line">        if (!options || !options.root) &#123;</div><div class="line">          type = namespace + type;//有namespace拼接后再触发</div><div class="line">          if (!store._actions[type]) &#123;</div><div class="line">            console.error((&quot;[vuex] unknown local action type: &quot; + (args.type) + &quot;, global type: &quot; + type));</div><div class="line">            return</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return store.dispatch(type, payload)</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      commit: noNamespace ? store.commit : function (_type, _payload, _options) &#123;</div><div class="line">        var args = unifyObjectStyle(_type, _payload, _options);</div><div class="line">        var payload = args.payload;</div><div class="line">        var options = args.options;</div><div class="line">        var type = args.type;</div><div class="line"></div><div class="line">        if (!options || !options.root) &#123;</div><div class="line">          type = namespace + type; //有namespace拼接后再触发</div><div class="line">          if (!store._mutations[type]) &#123;</div><div class="line">            console.error((&quot;[vuex] unknown local mutation type: &quot; + (args.type) + &quot;, global type: &quot; + type));</div><div class="line">            return</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        store.commit(type, payload, options);</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // getters and state object must be gotten lazily</div><div class="line">    // because they will be changed by vm update</div><div class="line">    Object.defineProperties(local, &#123;</div><div class="line">      getters: &#123;</div><div class="line">        get: noNamespace</div><div class="line">          ? function () &#123; return store.getters; &#125;</div><div class="line">          : function () &#123; return makeLocalGetters(store, namespace); &#125;</div><div class="line">      &#125;,</div><div class="line">      state: &#123;</div><div class="line">        get: function () &#123; return getNestedState(store.state, path); &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return local</div><div class="line">  &#125;</div><div class="line"></div><div class="line">function makeLocalGetters (store, namespace) &#123;</div><div class="line">  if (!store._makeLocalGettersCache[namespace]) &#123;</div><div class="line">    var gettersProxy = &#123;&#125;;</div><div class="line">    var splitPos = namespace.length;</div><div class="line">    Object.keys(store.getters).forEach(function (type) &#123;</div><div class="line">      // skip if the target getter is not match this namespace</div><div class="line">      if (type.slice(0, splitPos) !== namespace) &#123; return &#125;</div><div class="line"></div><div class="line">      // extract local getter type</div><div class="line">      var localType = type.slice(splitPos);</div><div class="line"></div><div class="line">      // Add a port to the getters proxy.</div><div class="line">      // Define as getter property because</div><div class="line">      // we do not want to evaluate the getters in this time.</div><div class="line">      Object.defineProperty(gettersProxy, localType, &#123;</div><div class="line">        get: function () &#123; return store.getters[type]; &#125;,</div><div class="line">        enumerable: true</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">    store._makeLocalGettersCache[namespace] = gettersProxy;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return store._makeLocalGettersCache[namespace]</div><div class="line">&#125;</div><div class="line">function getNestedState (state, path) &#123;</div><div class="line">  return path.reduce(function (state, key) &#123; return state[key]; &#125;, state)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>该步骤完成后</p>
<p>store对象长这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">commit: ƒ boundCommit(type, payload, options)</div><div class="line">dispatch: ƒ boundDispatch(type, payload)</div><div class="line">strict: false</div><div class="line">_actionSubscribers: []</div><div class="line">_actions: &#123;&#125; //存放所有模块的action</div><div class="line">_committing: false</div><div class="line">_makeLocalGettersCache: &#123;&#125;</div><div class="line">_modules: ModuleCollection &#123;</div><div class="line">  root: Module</div><div class="line">  context: //新增根据namespace处理后的触发函数</div><div class="line">    commit: ƒ boundCommit(type, payload, options)</div><div class="line">    dispatch: ƒ boundDispatch(type, payload)</div><div class="line">    getters: (...)</div><div class="line">    state: (...)</div><div class="line">    get getters: ƒ ()</div><div class="line">    get state: ƒ ()</div><div class="line">    __proto__: Object</div><div class="line">  runtime: false</div><div class="line">  state: //将子模块state集中到根模块state</div><div class="line">    a: &#123;counta: 2329&#125;</div><div class="line">    b:</div><div class="line">      aa: &#123;counta: 2329&#125;</div><div class="line">      countb: 0</div><div class="line">      __proto__: Object</div><div class="line">    count: 0</div><div class="line">    __proto__: Object</div><div class="line">  _children: //对子模块递归过程挂载context属性</div><div class="line">    a: Module &#123;runtime: false, _children: &#123;…&#125;, _rawModule: &#123;…&#125;, state: &#123;…&#125;, context: &#123;…&#125;&#125;</div><div class="line">    b: Module &#123;runtime: false, _children: &#123;…&#125;, _rawModule: &#123;…&#125;, state: &#123;…&#125;, context: &#123;…&#125;&#125;</div><div class="line">  _rawModule: &#123;state: &#123;…&#125;, mutations: &#123;…&#125;, modules: &#123;…&#125;&#125;</div><div class="line">  namespaced: (...)</div><div class="line">  __proto__: Object</div><div class="line">__proto__: Object</div><div class="line">&#125;</div><div class="line">_modulesNamespaceMap: &#123;b/: Module&#125; //存放设置了namespace的模块</div><div class="line">_mutations: &#123;increment: Array(1), incrementaaa: Array(1), b/increment: Array(1), b/incrementaaa: Array(1)&#125; //存放所有模块的mutation</div><div class="line">_subscribers: []</div><div class="line">_watcherVM: Vue &#123;_uid: 0, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: Vue, …&#125;</div><div class="line">_wrappedGetters: &#123;&#125; //存放所有模块的getters</div><div class="line">state: (...) //对局部变量做了处理，还没有挂到store上</div></pre></td></tr></table></figure>
<h1 id="resetStoreVM"><a href="#resetStoreVM" class="headerlink" title="resetStoreVM"></a>resetStoreVM</h1><p>利用vue的数据处理逻辑，解决getters和state之间订阅发布关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">function partial (fn, arg) &#123;</div><div class="line">  return function () &#123;</div><div class="line">    return fn(arg)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">function resetStoreVM (store, state, hot) &#123;</div><div class="line">    var oldVm = store._vm;</div><div class="line">    //绑定存储公共的getters</div><div class="line">    store.getters = &#123;&#125;;</div><div class="line">    // 重置内部getters缓存到_makeLocalGettersCache</div><div class="line">    store._makeLocalGettersCache = Object.create(null);</div><div class="line">    var wrappedGetters = store._wrappedGetters;</div><div class="line">    var computed = &#123;&#125;;</div><div class="line">    forEachValue(wrappedGetters, function (fn, key) &#123;</div><div class="line">      //如果直接使用，闭包里面会包含oldVm</div><div class="line">      computed[key] = partial(fn, store);</div><div class="line">      Object.defineProperty(store.getters, key, &#123;</div><div class="line">        get: function () &#123; return store._vm[key]; &#125;,//直接调用vue的compute属性</div><div class="line">        enumerable: true // for local getters</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    //使用vue实例存放state和getters</div><div class="line">    var silent = Vue.config.silent;</div><div class="line">    /* Vue.config.silent暂时设置为true的目的是在new一个Vue实例的过程中不会报出一切警告 */</div><div class="line">    Vue.config.silent = true</div><div class="line">    store._vm = new Vue(&#123;</div><div class="line">      data: &#123;</div><div class="line">        $$state: state</div><div class="line">      &#125;,</div><div class="line">      computed: computed</div><div class="line">    &#125;);</div><div class="line">    Vue.config.silent = silent;</div><div class="line"></div><div class="line">     /* 使能严格模式，保证修改store只能通过mutation */</div><div class="line">    if (store.strict) &#123;</div><div class="line">      enableStrictMode(store);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (oldVm) &#123;</div><div class="line">      if (hot) &#123;</div><div class="line">        // dispatch changes in all subscribed watchers</div><div class="line">        // to force getter re-evaluation for hot reloading.</div><div class="line">        store._withCommit(function () &#123;</div><div class="line">          oldVm._data.$$state = null;</div><div class="line">        &#125;);</div><div class="line">      &#125;</div><div class="line">      Vue.nextTick(function () &#123; return oldVm.$destroy(); &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h1 id="store上的其他方法"><a href="#store上的其他方法" class="headerlink" title="store上的其他方法"></a>store上的其他方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div></pre></td><td class="code"><pre><div class="line">Store.prototype.commit = function commit (_type, _payload, _options) &#123;</div><div class="line">  var this$1 = this;</div><div class="line"></div><div class="line">  // check object-style commit</div><div class="line">  var ref = unifyObjectStyle(_type, _payload, _options);</div><div class="line">  var type = ref.type;</div><div class="line">  var payload = ref.payload;</div><div class="line">  var options = ref.options;</div><div class="line"></div><div class="line">  var mutation = &#123; type: type, payload: payload &#125;;</div><div class="line">  var entry = this._mutations[type];</div><div class="line">  if (!entry) &#123;</div><div class="line">    &#123;</div><div class="line">      console.error((&quot;[vuex] unknown mutation type: &quot; + type));</div><div class="line">    &#125;</div><div class="line">    return</div><div class="line">  &#125;</div><div class="line">  this._withCommit(function () &#123;</div><div class="line">    entry.forEach(function commitIterator (handler) &#123;</div><div class="line">      handler(payload);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  this._subscribers</div><div class="line">    .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</div><div class="line">    .forEach(function (sub) &#123; return sub(mutation, this$1.state); &#125;);</div><div class="line"></div><div class="line">  if (</div><div class="line">    options &amp;&amp; options.silent</div><div class="line">  ) &#123;</div><div class="line">    console.warn(</div><div class="line">      &quot;[vuex] mutation type: &quot; + type + &quot;. Silent option has been removed. &quot; +</div><div class="line">      &apos;Use the filter functionality in the vue-devtools&apos;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Store.prototype.dispatch = function dispatch (_type, _payload) &#123;</div><div class="line">      var this$1 = this;</div><div class="line"></div><div class="line">    // check object-style dispatch</div><div class="line">    var ref = unifyObjectStyle(_type, _payload);</div><div class="line">      var type = ref.type;</div><div class="line">      var payload = ref.payload;</div><div class="line"></div><div class="line">    var action = &#123; type: type, payload: payload &#125;;</div><div class="line">    var entry = this._actions[type];</div><div class="line">    if (!entry) &#123;</div><div class="line">      &#123;</div><div class="line">        console.error((&quot;[vuex] unknown action type: &quot; + type));</div><div class="line">      &#125;</div><div class="line">      return</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">      this._actionSubscribers</div><div class="line">        .slice() // shallow copy to prevent iterator invalidation if subscriber synchronously calls unsubscribe</div><div class="line">        .filter(function (sub) &#123; return sub.before; &#125;)</div><div class="line">        .forEach(function (sub) &#123; return sub.before(action, this$1.state); &#125;);</div><div class="line">    &#125; catch (e) &#123;</div><div class="line">      &#123;</div><div class="line">        console.warn(&quot;[vuex] error in before action subscribers: &quot;);</div><div class="line">        console.error(e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    var result = entry.length &gt; 1</div><div class="line">      ? Promise.all(entry.map(function (handler) &#123; return handler(payload); &#125;))</div><div class="line">      : entry[0](payload);</div><div class="line"></div><div class="line">    return result.then(function (res) &#123;</div><div class="line">      try &#123;</div><div class="line">        this$1._actionSubscribers</div><div class="line">          .filter(function (sub) &#123; return sub.after; &#125;)</div><div class="line">          .forEach(function (sub) &#123; return sub.after(action, this$1.state); &#125;);</div><div class="line">      &#125; catch (e) &#123;</div><div class="line">        &#123;</div><div class="line">          console.warn(&quot;[vuex] error in after action subscribers: &quot;);</div><div class="line">          console.error(e);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      return res</div><div class="line">    &#125;)</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.subscribe = function subscribe (fn) &#123;</div><div class="line">    return genericSubscribe(fn, this._subscribers)</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.subscribeAction = function subscribeAction (fn) &#123;</div><div class="line">    var subs = typeof fn === &apos;function&apos; ? &#123; before: fn &#125; : fn;</div><div class="line">    return genericSubscribe(subs, this._actionSubscribers)</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.watch = function watch (getter, cb, options) &#123;</div><div class="line">      var this$1 = this;</div><div class="line"></div><div class="line">    &#123;</div><div class="line">      assert(typeof getter === &apos;function&apos;, &quot;store.watch only accepts a function.&quot;);</div><div class="line">    &#125;</div><div class="line">    return this._watcherVM.$watch(function () &#123; return getter(this$1.state, this$1.getters); &#125;, cb, options)</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.replaceState = function replaceState (state) &#123;</div><div class="line">      var this$1 = this;</div><div class="line"></div><div class="line">    this._withCommit(function () &#123;</div><div class="line">      this$1._vm._data.$$state = state;</div><div class="line">    &#125;);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.registerModule = function registerModule (path, rawModule, options) &#123;</div><div class="line">      if ( options === void 0 ) options = &#123;&#125;;</div><div class="line"></div><div class="line">    if (typeof path === &apos;string&apos;) &#123; path = [path]; &#125;</div><div class="line"></div><div class="line">    &#123;</div><div class="line">      assert(Array.isArray(path), &quot;module path must be a string or an Array.&quot;);</div><div class="line">      assert(path.length &gt; 0, &apos;cannot register the root module by using registerModule.&apos;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    this._modules.register(path, rawModule);</div><div class="line">    installModule(this, this.state, path, this._modules.get(path), options.preserveState);</div><div class="line">    // reset store to update getters...</div><div class="line">    resetStoreVM(this, this.state);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.unregisterModule = function unregisterModule (path) &#123;</div><div class="line">      var this$1 = this;</div><div class="line"></div><div class="line">    if (typeof path === &apos;string&apos;) &#123; path = [path]; &#125;</div><div class="line"></div><div class="line">    &#123;</div><div class="line">      assert(Array.isArray(path), &quot;module path must be a string or an Array.&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    this._modules.unregister(path);</div><div class="line">    this._withCommit(function () &#123;</div><div class="line">      var parentState = getNestedState(this$1.state, path.slice(0, -1));</div><div class="line">      Vue.delete(parentState, path[path.length - 1]);</div><div class="line">    &#125;);</div><div class="line">    resetStore(this);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype.hotUpdate = function hotUpdate (newOptions) &#123;</div><div class="line">    this._modules.update(newOptions);</div><div class="line">    resetStore(this, true);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Store.prototype._withCommit = function _withCommit (fn) &#123;</div><div class="line">    var committing = this._committing;</div><div class="line">    this._committing = true;</div><div class="line">    fn();</div><div class="line">    this._committing = committing;</div><div class="line">  &#125;;</div><div class="line">  </div><div class="line">  function genericSubscribe (fn, subs) &#123;</div><div class="line">    if (subs.indexOf(fn) &lt; 0) &#123;</div><div class="line">      subs.push(fn);</div><div class="line">    &#125;</div><div class="line">    return function () &#123;</div><div class="line">      var i = subs.indexOf(fn);</div><div class="line">      if (i &gt; -1) &#123;</div><div class="line">        subs.splice(i, 1);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function resetStore (store, hot) &#123;</div><div class="line">    store._actions = Object.create(null);</div><div class="line">    store._mutations = Object.create(null);</div><div class="line">    store._wrappedGetters = Object.create(null);</div><div class="line">    store._modulesNamespaceMap = Object.create(null);</div><div class="line">    var state = store.state;</div><div class="line">    // init all modules</div><div class="line">    installModule(store, state, [], store._modules.root, true);</div><div class="line">    // reset vm</div><div class="line">    resetStoreVM(store, state, hot);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/src4.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/src4.html" itemprop="url">
                  vue 源码学习四【数据双向绑定】
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-11T22:58:15+08:00">
                2020-04-11
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vue双向绑定原理，依赖收集是<br>在created声明周期之前，<br>render生成虚拟dom的时候<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Vue.prototype._init = function (options) &#123;</div><div class="line">  vm.$options = mergeOptions(</div><div class="line">    resolveConstructorOptions(vm.constructor),</div><div class="line">    options || &#123;&#125;,</div><div class="line">    vm</div><div class="line">  );</div><div class="line">  callHook(vm, &apos;beforeCreate&apos;);//运行订阅了beforecreate钩子的相关方法</div><div class="line">  initState(vm);//处理数据</div><div class="line">  callHook(vm, &apos;created&apos;);</div></pre></td></tr></table></figure></p>
<h1 id="转换"><a href="#转换" class="headerlink" title="转换"></a>转换</h1><p>转换成内置函数mergedInstanceDataFn<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">function mergeOptions (</div><div class="line">   parent,</div><div class="line">   child,</div><div class="line">   vm</div><div class="line"> ) &#123;</div><div class="line">   &#123;</div><div class="line">     checkComponents(child);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   if (typeof child === &apos;function&apos;) &#123;</div><div class="line">     child = child.options;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   // ... normalizeProps, normalizeInject, normalizeDirectives</div><div class="line"></div><div class="line">   if (!child._base) &#123;</div><div class="line">     if (child.extends) &#123;</div><div class="line">       parent = mergeOptions(parent, child.extends, vm);</div><div class="line">     &#125;</div><div class="line">     if (child.mixins) &#123;</div><div class="line">       for (var i = 0, l = child.mixins.length; i &lt; l; i++) &#123;</div><div class="line">         parent = mergeOptions(parent, child.mixins[i], vm);</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   var options = &#123;&#125;;</div><div class="line">   var key;</div><div class="line">   for (key in parent) &#123;</div><div class="line">     mergeField(key);</div><div class="line">   &#125;</div><div class="line">   for (key in child) &#123;</div><div class="line">     if (!hasOwn(parent, key)) &#123;</div><div class="line">       mergeField(key);</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">   //在上面的循环中会遍历到配置的options参数里的data属性，则会调用到strats.data</div><div class="line">   function mergeField (key) &#123; </div><div class="line">     var strat = strats[key] || defaultStrat;</div><div class="line">     options[key] = strat(parent[key], child[key], vm, key);</div><div class="line">   &#125;</div><div class="line">   return options</div><div class="line"> &#125;</div><div class="line"> //</div><div class="line"> strats.data = function (</div><div class="line">   parentVal,</div><div class="line">   childVal,</div><div class="line">   vm</div><div class="line"> ) &#123;</div><div class="line">   if (!vm) &#123;</div><div class="line">     //...vm就是VUE实例，所以不会走这里</div><div class="line">     return mergeDataOrFn(parentVal, childVal)</div><div class="line">   &#125;</div><div class="line">   return mergeDataOrFn(parentVal, childVal, vm)</div><div class="line"> &#125;;</div><div class="line"></div><div class="line"> function mergeDataOrFn (</div><div class="line">   parentVal,</div><div class="line">   childVal,</div><div class="line">   vm</div><div class="line"> ) &#123;</div><div class="line">   if (!vm) &#123;</div><div class="line">     ...</div><div class="line">   &#125; else &#123;</div><div class="line">     return function mergedInstanceDataFn () &#123;</div><div class="line">       // instance merge</div><div class="line">       var instanceData = typeof childVal === &apos;function&apos;</div><div class="line">         ? childVal.call(vm, vm)</div><div class="line">         : childVal;</div><div class="line">       var defaultData = typeof parentVal === &apos;function&apos;</div><div class="line">         ? parentVal.call(vm, vm)</div><div class="line">         : parentVal;</div><div class="line">       if (instanceData) &#123;</div><div class="line">         return mergeData(instanceData, defaultData)</div><div class="line">       &#125; else &#123;</div><div class="line">         return defaultData</div><div class="line">       &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>这一步结束后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">vm.$options.data = function mergedInstanceDataFn () &#123;</div><div class="line">  //声明时传递进来的data属性值,是函数则执行拿到对象</div><div class="line">  var instanceData = typeof childVal === &apos;function&apos; </div><div class="line">    ? childVal.call(vm, vm)</div><div class="line">    : childVal;</div><div class="line">  //内部属性没有data属性，所以 defaultData 为undefined</div><div class="line">  var defaultData = typeof parentVal === &apos;function&apos;</div><div class="line">    ? parentVal.call(vm, vm)</div><div class="line">    : parentVal;</div><div class="line">  if (instanceData) &#123;</div><div class="line">    return mergeData(instanceData, defaultData)</div><div class="line">  &#125; else &#123;</div><div class="line">    return defaultData</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">function mergeData (to, from) &#123;</div><div class="line">  if (!from) &#123; return to &#125;</div><div class="line">  ...//省略若干逻辑</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="数据劫持"><a href="#数据劫持" class="headerlink" title="数据劫持"></a>数据劫持</h1><p>开始进行真正初始化—数据劫持<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">function initState (vm) &#123;</div><div class="line">  vm._watchers = [];</div><div class="line">  var opts = vm.$options;</div><div class="line">  if (opts.data) &#123;</div><div class="line">    initData(vm);</div><div class="line">  &#125; else &#123;</div><div class="line">    observe(vm._data = &#123;&#125;, true /* asRootData */);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function initData (vm) &#123;</div><div class="line">    var data = vm.$options.data;</div><div class="line">    data = vm._data = typeof data === &apos;function&apos;</div><div class="line">      ? getData(data, vm)</div><div class="line">      : data || &#123;&#125;;</div><div class="line">    //得到的data不是object对象</div><div class="line">    if (!isPlainObject(data)) &#123;</div><div class="line">      data = &#123;&#125;;</div><div class="line">    &#125;</div><div class="line">    // proxy data on instance</div><div class="line">    var keys = Object.keys(data);</div><div class="line">    var props = vm.$options.props;</div><div class="line">    var methods = vm.$options.methods;</div><div class="line">    var i = keys.length;</div><div class="line">    while (i--) &#123;</div><div class="line">      var key = keys[i];</div><div class="line">      &#123;if (methods &amp;&amp; hasOwn(methods, key)) &#123;...与method同名警告&#125;&#125;</div><div class="line">      if (props &amp;&amp; hasOwn(props, key)) &#123;</div><div class="line">       ...与prop同名警告</div><div class="line">      &#125; else if (!isReserved(key)) &#123; //不是以$或者_开头的key</div><div class="line">        proxy(vm, &quot;_data&quot;, key); //将key值存一份到vm的&apos;_data&apos;属性上</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    // observe data</div><div class="line">    observe(data, true /* asRootData */);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function getData (data, vm) &#123;</div><div class="line">    // #7573 disable dep collection when invoking(调用) data getters</div><div class="line">    pushTarget();</div><div class="line">    try &#123;</div><div class="line">      return data.call(vm, vm)</div><div class="line">    &#125; catch (e) &#123;</div><div class="line">      handleError(e, vm, &quot;data()&quot;);</div><div class="line">      return &#123;&#125;</div><div class="line">    &#125; finally &#123;</div><div class="line">      popTarget();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  var sharedPropertyDefinition = &#123;</div><div class="line">    enumerable: true,</div><div class="line">    configurable: true,</div><div class="line">    get: noop,</div><div class="line">    set: noop</div><div class="line">  &#125;;</div><div class="line">  function proxy (target, sourceKey, key) &#123;</div><div class="line">    sharedPropertyDefinition.get = function proxyGetter () &#123;</div><div class="line">      return this[sourceKey][key]</div><div class="line">    &#125;;</div><div class="line">    sharedPropertyDefinition.set = function proxySetter (val) &#123;</div><div class="line">      this[sourceKey][key] = val;</div><div class="line">    &#125;;</div><div class="line">    Object.defineProperty(target, key, sharedPropertyDefinition);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>给data创建观察者实例，挂载‘<em>ob</em>’属性，指向一个Observer对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">function observe (value, asRootData) &#123;</div><div class="line">  if (!isObject(value) || value instanceof VNode) &#123;</div><div class="line">    return</div><div class="line">  &#125;</div><div class="line">  var ob;</div><div class="line">  if (hasOwn(value, &apos;__ob__&apos;) &amp;&amp; value.__ob__ instanceof Observer) &#123;</div><div class="line">    ob = value.__ob__;</div><div class="line">  &#125; else if (</div><div class="line">    shouldObserve &amp;&amp;</div><div class="line">    !isServerRendering() &amp;&amp;</div><div class="line">    (Array.isArray(value) || isPlainObject(value)) &amp;&amp;</div><div class="line">    Object.isExtensible(value) &amp;&amp;</div><div class="line">    !value._isVue</div><div class="line">  ) &#123;</div><div class="line">    ob = new Observer(value);</div><div class="line">  &#125;</div><div class="line">  if (asRootData &amp;&amp; ob) &#123;</div><div class="line">    ob.vmCount++;</div><div class="line">  &#125;</div><div class="line">  return ob</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Observer对象有三个属性,‘<strong>ob</strong>’属性相同<br>{<br>  value:data,<br>  dep : new Dep();<br>  vmCount :0<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">var Observer = function Observer (value) &#123;</div><div class="line">  this.value = value;</div><div class="line">  this.dep = new Dep();</div><div class="line">  this.vmCount = 0;</div><div class="line">  def(value, &apos;__ob__&apos;, this);</div><div class="line">  if (Array.isArray(value)) &#123;</div><div class="line">    if (hasProto) &#123;</div><div class="line">      protoAugment(value, arrayMethods);</div><div class="line">    &#125; else &#123;</div><div class="line">      copyAugment(value, arrayMethods, arrayKeys);</div><div class="line">    &#125;</div><div class="line">    this.observeArray(value);</div><div class="line">  &#125; else &#123;</div><div class="line">    this.walk(value);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">function def (obj, key, val, enumerable) &#123;</div><div class="line">  Object.defineProperty(obj, key, &#123;</div><div class="line">    value: val,</div><div class="line">    enumerable: !!enumerable,</div><div class="line">    writable: true,</div><div class="line">    configurable: true</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line">//遍历所有属性并将它们转换为getter / setter。 </div><div class="line">//仅当值类型为Object时才应调用此方法。</div><div class="line">Observer.prototype.walk = function walk (obj) &#123;</div><div class="line">  var keys = Object.keys(obj);</div><div class="line">  for (var i = 0; i &lt; keys.length; i++) &#123;</div><div class="line">    defineReactive$$1(obj, keys[i]);</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>真正进行劫持的方法defineReactive$$1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">function defineReactive$$1 (</div><div class="line">    obj,</div><div class="line">    key,</div><div class="line">    val,</div><div class="line">    customSetter,</div><div class="line">    shallow</div><div class="line">  ) &#123;</div><div class="line">    var dep = new Dep();</div><div class="line"></div><div class="line">    var property = Object.getOwnPropertyDescriptor(obj, key);</div><div class="line">    if (property &amp;&amp; property.configurable === false) &#123;</div><div class="line">      return</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // cater(迎合) for pre-defined getter/setters</div><div class="line">    var getter = property &amp;&amp; property.get;</div><div class="line">    var setter = property &amp;&amp; property.set;</div><div class="line">    if ((!getter || setter) &amp;&amp; arguments.length === 2) &#123;</div><div class="line">      val = obj[key];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    var childOb = !shallow &amp;&amp; observe(val);//对值进行劫持处理 开始递归处理</div><div class="line">    Object.defineProperty(obj, key, &#123;</div><div class="line">      enumerable: true,</div><div class="line">      configurable: true,</div><div class="line">      get: function reactiveGetter () &#123;</div><div class="line">        var value = getter ? getter.call(obj) : val;</div><div class="line">        if (Dep.target) &#123; //new watch的时候，Dep.target指向Watcher对象,再运行render函数，访问具体变量就会调用这里</div><div class="line">          dep.depend();//对key的依赖进行依赖收集</div><div class="line">          if (childOb) &#123;//如果值是一个对象的情况下</div><div class="line">            childOb.dep.depend();//对对象值的依赖进行依赖收集 实现深度监听</div><div class="line">            if (Array.isArray(value)) &#123;</div><div class="line">              dependArray(value);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        return value</div><div class="line">      &#125;,</div><div class="line">      set: function reactiveSetter (newVal) &#123;</div><div class="line">        var value = getter ? getter.call(obj) : val;</div><div class="line">        //相同值，不更新</div><div class="line">        if (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</div><div class="line">          return</div><div class="line">        &#125;</div><div class="line">        //有setter方法直接用setter方法更新，没有直接赋值</div><div class="line">        if (getter &amp;&amp; !setter) &#123; return &#125;</div><div class="line">        if (setter) &#123;</div><div class="line">          setter.call(obj, newVal);</div><div class="line">        &#125; else &#123;</div><div class="line">          val = newVal;</div><div class="line">        &#125;</div><div class="line">        //对新值进行劫持处理 更新childOb</div><div class="line">        //如果新值是对象对新赋的值在更新时进行依赖收集</div><div class="line">        childOb = !shallow &amp;&amp; observe(newVal); </div><div class="line">        dep.notify();</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>每个被劫持过的数据的标识<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">var Dep = function Dep () &#123;</div><div class="line">  this.id = uid++;</div><div class="line">  this.subs = [];</div><div class="line">&#125;;</div><div class="line">Dep.prototype.addSub = function addSub (sub) &#123;</div><div class="line">  this.subs.push(sub);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Dep.prototype.depend = function depend () &#123;</div><div class="line">  if (Dep.target) &#123;</div><div class="line">    Dep.target.addDep(this); //调用Watcher.addDep方法，this指dep</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Dep.prototype.notify = function notify () &#123;</div><div class="line">  // stabilize the subscriber list first</div><div class="line">  var subs = this.subs.slice();</div><div class="line">  if (!config.async) &#123;</div><div class="line">    // subs aren&apos;t sorted in scheduler if not running async</div><div class="line">    // we need to sort them now to make sure they fire in correct</div><div class="line">    // order</div><div class="line">    subs.sort(function (a, b) &#123; return a.id - b.id; &#125;);</div><div class="line">  &#125;</div><div class="line">  for (var i = 0, l = subs.length; i &lt; l; i++) &#123;</div><div class="line">    subs[i].update(); //执行watcher的update函数</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">Dep.target = null;</div><div class="line">var targetStack = [];</div></pre></td></tr></table></figure></p>
<h1 id="订阅发布"><a href="#订阅发布" class="headerlink" title="订阅发布"></a>订阅发布</h1><p>mountComponent函数会new Watcher一个对象,执行get方法【详见源码分析二】<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">var _Set;</div><div class="line">/* istanbul ignore if */ // $flow-disable-line</div><div class="line">if (typeof Set !== &apos;undefined&apos; &amp;&amp; isNative(Set)) &#123;</div><div class="line">  // use native Set when available.</div><div class="line">  _Set = Set;</div><div class="line">&#125; else &#123;</div><div class="line">  // a non-standard Set polyfill that only works with primitive keys.</div><div class="line">  _Set = /*@__PURE__*/(function () &#123;</div><div class="line">    function Set () &#123;</div><div class="line">      this.set = Object.create(null);</div><div class="line">    &#125;</div><div class="line">    Set.prototype.has = function has (key) &#123;</div><div class="line">      return this.set[key] === true</div><div class="line">    &#125;;</div><div class="line">    Set.prototype.add = function add (key) &#123;</div><div class="line">      this.set[key] = true;</div><div class="line">    &#125;;</div><div class="line">    Set.prototype.clear = function clear () &#123;</div><div class="line">      this.set = Object.create(null);</div><div class="line">    &#125;;</div><div class="line">    return Set;</div><div class="line">  &#125;());</div><div class="line">&#125;</div><div class="line">var Watcher = function Watcher (...args)&#123;</div><div class="line">  this.deps = [];</div><div class="line">  this.newDeps = [];</div><div class="line">  this.depIds = new _Set();</div><div class="line">  this.newDepIds = new _Set();</div><div class="line">&#125;</div><div class="line">Watcher.prototype.get = function get () &#123;</div><div class="line">    pushTarget(this); //将当前Watcher挂到第三方Dep.target上</div><div class="line">    var value;</div><div class="line">    var vm = this.vm;</div><div class="line">    try &#123;</div><div class="line">      //this.getter会执行render,触发数据的get方法，进行相互订阅</div><div class="line">      value = this.getter.call(vm, vm); </div><div class="line">    &#125; catch (e) &#123;</div><div class="line">      ...</div><div class="line">    &#125; finally &#123;</div><div class="line">      // &quot;touch&quot; every property so they are all tracked as</div><div class="line">      // dependencies for deep watching</div><div class="line">      if (this.deep) &#123;</div><div class="line">        traverse(value);</div><div class="line">      &#125;</div><div class="line">      popTarget();</div><div class="line">      this.cleanupDeps();</div><div class="line">    &#125;</div><div class="line">    return value</div><div class="line">  &#125;;</div><div class="line">function pushTarget (target) &#123;</div><div class="line">  targetStack.push(target);</div><div class="line">  Dep.target = target;</div><div class="line">&#125;</div><div class="line">//watcher和dep互相存id</div><div class="line">Watcher.prototype.addDep = function addDep (dep) &#123; </div><div class="line">  var id = dep.id;</div><div class="line">  if (!this.newDepIds.has(id)) &#123;</div><div class="line">    this.newDepIds.add(id);</div><div class="line">    this.newDeps.push(dep);</div><div class="line">    if (!this.depIds.has(id)) &#123;</div><div class="line">      dep.addSub(this); //将watcher加入到dep的sub属性中</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">Watcher.prototype.update = function update () &#123;</div><div class="line">  /* istanbul ignore else */</div><div class="line">  if (this.lazy) &#123;</div><div class="line">    this.dirty = true;</div><div class="line">  &#125; else if (this.sync) &#123;</div><div class="line">    this.run();</div><div class="line">  &#125; else &#123;</div><div class="line">    queueWatcher(this);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">Watcher.prototype.run = function run () &#123;</div><div class="line">  if (this.active) &#123;</div><div class="line">    var value = this.get(); //重新调用render函数更新数据</div><div class="line">    if (</div><div class="line">      value !== this.value ||</div><div class="line">      //对于需要深度监听的数据类型，值没有变，也许值内容发生了变化 </div><div class="line">      isObject(value) ||</div><div class="line">      this.deep</div><div class="line">    ) &#123;</div><div class="line">      var oldValue = this.value;</div><div class="line">      this.value = value;</div><div class="line">      if (this.user) &#123;</div><div class="line">        try &#123;</div><div class="line">          this.cb.call(this.vm, value, oldValue);</div><div class="line">        &#125; catch (e) &#123;</div><div class="line">          handleError(e, this.vm, (&quot;callback for watcher \&quot;&quot; + (this.expression) + &quot;\&quot;&quot;));</div><div class="line">        &#125;</div><div class="line">      &#125; else &#123;</div><div class="line">        this.cb.call(this.vm, value, oldValue);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/YooHannah/algorithm/blob/master/html/vuesrc/dataResponse.js" target="_blank" rel="external">vue3.0数据响应式原理</a></p>
<h1 id="vue3-0的改进"><a href="#vue3-0的改进" class="headerlink" title="vue3.0的改进"></a>vue3.0的改进</h1><p>1.对源码进行优化<br>使用monorepo和TS管理和开发源码，提升自身代码的可维护性<br>2.性能优化<br>减少源码体积<br>移除冷门的feature(如filter,inline-template)<br>引入tree-shaking,减小打包体积</p>
<p>数据劫持优化<br>原来缺点<br>无法判断对象属性删除新增<br>深度层次结点要递归遍历，也不知道会不会用到，都要劫持，不友好</p>
<p>解决<br>使用proxy API 可以检测到删除还是新增<br>在用到时才劫持，避免无脑递归</p>
<p>3.编译优化<br>判断更新的颗粒度变小，从原来的组件级，利用block tree的区块细化到动态节点级<br>引入 compositionAPI 优化逻辑关注点相关的代码，可以避免mixin的时候的命名冲突</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/sso.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/sso.html" itemprop="url">
                  sso单点登录实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-25T23:27:15+08:00">
                2020-03-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>多项目想要实现统一登录，即登录一个系统后，在打开其他相关系统页面后，是已经登录的状态，不再进行登录</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>多个系统使用统一的顶级域名，利用cookie的domain属性，将登录后cookie保存在浏览器中，只要是该cookie的domain所包含的域名的站点，都可以拿到这个cookie</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>选择原来多个站点中其中一个站点的登录页，作为公共跳转页<br>在登录之后将token塞到浏览器中<br>这里设置统一token在cookie中的key值为_a<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">根据运行环境设置domain,sit,dev均为测试环境</div><div class="line">function getDomain(name)&#123;</div><div class="line">  let testENVs = [&apos;localhost&apos;,&apos;sit&apos;,&apos;dev&apos;]</div><div class="line">  let testENV = &apos;&apos;</div><div class="line">  testENVs.forEach(env=&gt;&#123;</div><div class="line">    if(location.hostname.includes(env))&#123; //根据域名判断环境</div><div class="line">      testENV = env</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">  let temp = testENV?testENV +&apos;.xxxx.com&apos;:&apos;xxxx.com&apos;</div><div class="line">  //本地开发不加domain,默认localhost,否则本地没办法进行开发</div><div class="line">  let domain = testENV === &apos;localhost&apos; ? &apos;&apos;: (name === &apos;_a&apos;? temp:location.hostname)//个别cookie字段仅用于本站点，所以domain设置为站点域名</div><div class="line">  return domain</div><div class="line">&#125;</div><div class="line">setCookie=(name,value) =&gt; &#123;</div><div class="line">    const Days = 0.5</div><div class="line">    const exp = new Date()</div><div class="line">    exp.setTime(exp.getTime() + Days*24*60*60*1000)</div><div class="line">    let str =  name + &apos;=&apos; + escape(value) + &apos;;expires=&apos; + exp.toGMTString()</div><div class="line">    let domain = getDomain(name)</div><div class="line">    if(domain)&#123;</div><div class="line">      str +=&apos;;domain=&apos; + domain</div><div class="line">    &#125;</div><div class="line">    document.cookie = str</div><div class="line">  &#125;,</div></pre></td></tr></table></figure></p>
<p>之所以要根据不同运行环境设置不同domain,是因为要在不同测试环境也要实现单点登录<br>比如测试环境在sit环境的a.sit.xxxx.com和b.sit.xxxx.com<br>a.sit.xxxx.com登录页作为公共登录页<br>在a.sit.xxxx.com登录后，token的cookie会被设置成<br>key是_a,domain是sit.xxxx.com(浏览器会自动在前面加一个点)，这样打开b.sit.xxxx.com的页面，浏览器中还会存在_a这个cookie,b.sit.xxxx.com就可以直接拿这个cookie向服务器发请求了</p>
<p>以此类推，在dev环境，这两个站点域名会变成<br>a.dev.xxxx.com和b.dev.xxxx.com<br>_a的domain会被设置成dev.xxxx.com<br>这时如果去b.dev.xxxx.com,_a是会有的<br>但去a.sit.xxxx.com,是不会有的，因为_a此时仅限于dev.xxxx.com域名及其子域名</p>
<p>等到了生产环境，二者域名变为<br>a.xxxx.com和b.xxxx.com<br>_a的domain会被设置成xxxx.com<br>此时就会出现一个问题，假如我先登录了线上环境<br>有了domain为xxxx.com的_a<br>再去测试环境登录，此时会加进去domain为sit/dev.xxx.com的_a<br>两个_a如何区分哪个才是当前环境的_a？</p>
<p>遇到的问题一 ：测试环境_a加不进去，出现一闪而过<br>开始以为是浏览器机制问题，后来才发现，是代码逻辑问题<br>其实cookie是有写进浏览器的，跟cookie本身处理机制无关，可以写进去，问题出在了取cookie _a再给后台发请求的时候，以前是保存token的只有一个特殊key名，直接取那个key名就行，现在有两个_a，逻辑还是按照第一个来取，结果取错了，后台给发过来401，前端代码处理http状态码的逻辑又是401清cookie跳登录，所以domain为. sit/dev. xxxx. com的cookie就又消失了😅</p>
<p>遇到问题二 ：两个_a如何区分哪个才是当前环境的_a？<br>因为后台实现分层，与前端直接对接的后台，无法访问后台的用户cookie表，能拿到cookie表的后台站在大局角度看问题，这个逻辑又觉得不是有必要加的，所以不能要求后台拿到报文中cookie后去表里面做判断<br>所以由前端通过读取document.cookie,整理拿到两个_a后，依次用每个_a去给后台发请求，如果成功了，说明当前_a是正确的，就可以用这个_a去发真正的请求，同时记录下这个_a,避免之后的重复探测</p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>1.碰到问题一时，很无厘头，但分析出原因后，让人感觉很无语，正确的说是，让人很没面子，遇到问题应该善于分析，戒骄戒躁<br>2.问题二，有时候，你认为很恶心的做法，恰巧可能会被采纳</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>发版到线上后，发现部分同事登陆成功后又跳回登录页面，中间发起的请求报401</p>
<p>经过查看同事浏览器的cookie发现,存在设置了httponly的_a，即我们所有系统统一使用的token标识，<br>cookie设置了httponly意味着js没有权限进行获取更改甚至不能删除，所以新登录的token是没有写进去的，拿到的token也就是错的<br>解决办法就是让后台同事强制写一个没有httponly的_a进去，让后台覆盖后台，<br>说明浏览器优先级是先处理set-cookie的cookie逻辑，再看是否有httponly,决定js是否有权限处理cookie</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuepress.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuepress.html" itemprop="url">
                  使用vuepress构建文档系统
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T13:18:15+08:00">
                2020-03-24
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>面向普通用户的应用系统，包含很多产品的使用说明，属于静态页面<br>一方面占据整体项目的体积，打包时间用时长，打包结果体积大<br>另一方面，不断新增的不同产品的使用说明，对于前端开发人员来说，<br>相对开发真正的产品功能来说优先级较低，且占用开发时间</p>
<p>所以希望将产品使用说明与当前项目隔离，建立静态网站，存放使用说明<br>再由原系统进行跳转<br>将新增使用说明的任务交由相关产品负责人等非开发人员进行新增</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>1.对于非开发人员来说，选择何种文档格式，可以既方便编写，又可以轻松转成html<br>2.原有系统用vue编写的批量文件如何迁移到新的静态网站</p>
<h1 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h1><h2 id="vuepress"><a href="#vuepress" class="headerlink" title="vuepress"></a>vuepress</h2><p>vuepress是一款使用vue驱动的静态网站生成器<br>用户可以使用markdown格式文件编辑文本，然后转义成html<br>另外页面中功能还可以使用vue进行嵌入</p>
<h2 id="批量迁移"><a href="#批量迁移" class="headerlink" title="批量迁移"></a>批量迁移</h2><p>原系统vue编写的批量页面含有vue语法，不能直接迁移<br>所以需要将生成好的html爬下来转成md文件，应用到新系统<br>‘html-to-md’的npm 包可以帮助将html转换成md</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h2 id="vuepress搭建"><a href="#vuepress搭建" class="headerlink" title="vuepress搭建"></a>vuepress搭建</h2><p>因为要与原系统主题风格样式类似，故需要在原来主题代码上进行修改<br>安装好vuepress包之后<br>将包里面的默认主题@vuepress/theme-default复制粘贴到doc/.vuepress/theme文件夹下面<br>修改里面的代码就可以直接应用了</p>
<h3 id="配置config-js文件"><a href="#配置config-js文件" class="headerlink" title="配置config.js文件"></a>配置config.js文件</h3><p>在.vuepress文件夹下新增config.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">title:标签页名称</div><div class="line">head:在页面头部引入的文件</div><div class="line">base:当不在域名根目录下部署时，配置部署路径</div><div class="line">themeConfig:&#123; 主题配置</div><div class="line">  logo：标题栏左上角logo</div><div class="line">  nav:右上角搜索后面的按钮</div><div class="line">  sidebar:左侧侧边栏</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="enhanceApp-js"><a href="#enhanceApp-js" class="headerlink" title="enhanceApp.js"></a>enhanceApp.js</h3><p>在.vuepress文件夹下新增enhanceApp.js<br>该文件，可以添加对项目的额外处理<br>比如当前项目右上角三个按钮根据权限显示<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">export default (&#123;</div><div class="line">  Vue, // VUE构造函数对象</div><div class="line">  options, // vue实例选项</div><div class="line">  router, // 路由对象</div><div class="line">  siteData//配置的数据</div><div class="line">&#125;) =&gt; &#123;</div><div class="line">  async function getAuthorization()&#123;</div><div class="line">    if(location.hostname.includes(&apos;localhost&apos;))&#123;</div><div class="line">      return true</div><div class="line">    &#125;</div><div class="line">    let cookie_str = document.cookie</div><div class="line">    let cookie_parts = cookie_str.split(&apos;;&apos;)</div><div class="line">    let auths = []</div><div class="line">    cookie_parts.forEach(c=&gt;&#123;</div><div class="line">      if (c)&#123;</div><div class="line">        let kv = c.split(&apos;=&apos;)</div><div class="line">        let k = kv[0].trim()</div><div class="line">        let v = kv[1].trim()</div><div class="line">        if (k == &apos;_a&apos;)&#123;</div><div class="line">          auths.push(v)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line">    if(auths.length&lt;1)&#123;</div><div class="line">      return false</div><div class="line">    &#125;</div><div class="line">    for (var c of auths)&#123;</div><div class="line">      try &#123;</div><div class="line">        let response = await axios.get(location.origin + &apos;/api/v1/edit-user&apos;, &#123;headers: &#123;&apos;X-Auth-Token&apos;: c&#125;&#125;)</div><div class="line">        if(response.status &lt; 400)&#123;</div><div class="line">          return true</div><div class="line">        &#125;</div><div class="line">      &#125; catch (err) &#123;</div><div class="line">        console.log(err)</div><div class="line">        return false</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  getAuthorization().then(flag=&gt;&#123;</div><div class="line">    let divs = document.getElementsByClassName(&apos;nav-item&apos;)</div><div class="line">    if(flag)&#123;</div><div class="line">      divs[1].style.display = &apos;none&apos;</div><div class="line">      divs[2].style.display = &apos;none&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="更改页面呈现样式"><a href="#更改页面呈现样式" class="headerlink" title="更改页面呈现样式"></a>更改页面呈现样式</h3><p>增加悬浮锚点定位<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">page.vue</div><div class="line">&lt;template&gt;</div><div class="line">  &lt;main class=&quot;page&quot;&gt;</div><div class="line">    &lt;div v-show=&quot;$page.headers &amp;&amp; isShowAncher &amp;&amp; $page.frontmatter.ancherShow&quot; class=&apos;ancherSection&apos;&gt;</div><div class="line">      &lt;template v-for=&quot;(item,i) in headers&quot;&gt;</div><div class="line">        &lt;div :key=&quot;i&quot;&gt;</div><div class="line">          &lt;a  @click=&quot;gotoAncher(item.slug)&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/a&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">      &lt;/template&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;slot name=&quot;top&quot; /&gt;</div><div class="line"></div><div class="line">    &lt;Content class=&quot;theme-default-content&quot; /&gt;</div><div class="line">    &lt;PageEdit /&gt;</div><div class="line"></div><div class="line">    &lt;PageNav v-bind=&quot;&#123; sidebarItems &#125;&quot; /&gt;</div><div class="line">  </div><div class="line">    &lt;slot name=&quot;bottom&quot; /&gt;</div><div class="line">  &lt;/main&gt;</div><div class="line">&lt;/template&gt;</div><div class="line"></div><div class="line">export default &#123;</div><div class="line">  components: &#123; PageEdit, PageNav&#125;,</div><div class="line">  props: [&apos;sidebarItems&apos;],</div><div class="line">  data () &#123;</div><div class="line">    return &#123;</div><div class="line">      isShowAncher: false, //滚动过程控制悬浮锚点</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  computed:&#123;</div><div class="line">    headers:function()&#123;//计算锚点内容</div><div class="line">      let ancherLevel = this.$page.frontmatter.ancherLevel </div><div class="line">      let sidebarDepth = this.$page.frontmatter.sidebarDepth?this.$page.frontmatter.sidebarDepth:this.$themeConfig.sidebarDepth</div><div class="line">      let levelStr = ancherLevel?ancherLevel:(sidebarDepth&gt;1?&apos;h2,h3&apos;:&apos;h2&apos;)</div><div class="line">      if(ancherLevel &amp;&amp; !(/^(h2|h3|h2\,\s*\h3)$/ig.test(ancherLevel.trim())))&#123;</div><div class="line">        return []</div><div class="line">      &#125;</div><div class="line">      if(levelStr.includes(&apos;,&apos;))&#123;</div><div class="line">        return this.$page.headers &amp;&amp; groupHeaders(this.$page.headers).length&gt;0?this.$page.headers:[]</div><div class="line">      &#125;else&#123;</div><div class="line">        let level = +levelStr[1]</div><div class="line">        return this.$page.headers.filter(h =&gt; h.level === level)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  updated()&#123;</div><div class="line">    this.setPictureZoom()</div><div class="line">  &#125;,</div><div class="line">  mounted () &#123;</div><div class="line">    let  handleScroll= ()=&gt;&#123;</div><div class="line">      let scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop // 滚动条偏移量</div><div class="line">      this.isShowAncher = !!scrollTop</div><div class="line">    &#125;</div><div class="line">    window.addEventListener(&apos;scroll&apos;,handleScroll,false)</div><div class="line">    this.setPictureZoom()</div><div class="line">  &#125;,</div><div class="line">  methods:&#123;</div><div class="line">    //锚点定位</div><div class="line">    gotoAncher(ancher)&#123;</div><div class="line">      let el = document.getElementById(ancher)</div><div class="line">      let anchersHeight = document.getElementsByClassName(&apos;ancherSection&apos;)[0].clientHeight</div><div class="line">      window.scrollTo(&#123; </div><div class="line">          top: el.offsetTop-anchersHeight, </div><div class="line">          behavior: &quot;smooth&quot; </div><div class="line">      &#125;)</div><div class="line">    &#125;,</div><div class="line">    //添加图片放大功能</div><div class="line">    setPictureZoom () &#123;</div><div class="line">      let img = document.querySelectorAll(&apos;p &gt; img&apos;)</div><div class="line">        for (let i = 0; i &lt; img.length; i++) &#123;</div><div class="line">            if (img[i]) &#123;</div><div class="line">                let a = document.createElement(&quot;a&quot;);</div><div class="line">                let parent = img[i].parentNode</div><div class="line">                parent.appendChild(a)</div><div class="line">                let src = img[i].getAttribute(&apos;src&apos;)</div><div class="line">                a.setAttribute(&apos;data-fancybox&apos;, &apos;&apos;)</div><div class="line">                a.setAttribute(&apos;href&apos;, src)</div><div class="line">                a.appendChild(img[i])</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;style lang=&quot;stylus&quot;&gt;</div><div class="line">@require &apos;../styles/wrapper.styl&apos;</div><div class="line">.page</div><div class="line">  padding-bottom 2rem</div><div class="line">  display block</div><div class="line">.ancherSection</div><div class="line">  position: fixed</div><div class="line">  background-color: white</div><div class="line">  box-shadow: rgb(234, 229, 229) 0px 1px 2px;</div><div class="line">  top: 64px</div><div class="line">  min-height: 42px</div><div class="line">  width: calc(100% - 320px);</div><div class="line">  display flex</div><div class="line">  align-items center</div><div class="line">  justify-content left</div><div class="line">  flex-wrap: wrap;</div><div class="line">  padding: 10px 0px 0px;</div><div class="line">  z-index:2</div><div class="line">  div</div><div class="line">    margin-left 20px</div><div class="line">    margin-bottom: 10px;</div><div class="line">    a</div><div class="line">      color black</div><div class="line">      cursor pointer</div><div class="line"></div><div class="line">&lt;/style&gt;</div></pre></td></tr></table></figure></p>
<h3 id="更换图标"><a href="#更换图标" class="headerlink" title="更换图标"></a>更换图标</h3><p>在sidebarGroup.vue文件同级别新增arrow.svg图片，使用相对路径可插入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img src=&apos;./arrow.svg&apos; v-if=&quot;collapsable&quot; :class=&quot;open ? &apos;down&apos; : &apos;&apos;&quot; style=&apos;width:20px&apos; /&gt;</div></pre></td></tr></table></figure></p>
<h2 id="批量迁移-1"><a href="#批量迁移-1" class="headerlink" title="批量迁移"></a>批量迁移</h2><h3 id="目录改造"><a href="#目录改造" class="headerlink" title="目录改造"></a>目录改造</h3><p>原有系统页面图片按照产品名命名文件夹，故先将整体文件结构进行改造<br>原来目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">--content</div><div class="line">  --a</div><div class="line">    --a1.png</div><div class="line">    --a2.png</div><div class="line">    ......省略若干</div><div class="line">    --a13.png</div><div class="line">  --b</div><div class="line">    --b1.png</div><div class="line">    --b2.png</div><div class="line">    ......省略若干</div><div class="line">    --b13.png</div></pre></td></tr></table></figure></p>
<p>改造成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">--content</div><div class="line">  --a</div><div class="line">    --images</div><div class="line">        --a1.png</div><div class="line">        --a2.png</div><div class="line">        ......省略若干</div><div class="line">        --a13.png</div><div class="line">  --b</div><div class="line">    --images</div><div class="line">      --b1.png</div><div class="line">      --b2.png</div><div class="line">      ......省略若干</div><div class="line">      --b13.png</div></pre></td></tr></table></figure></p>
<p>就是在当前父文件夹下新增images文件夹，然后把图片移进去<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">var fs = require(&apos;fs&apos;);//引用文件系统模块</div><div class="line">function readFileList(path, filesList) &#123;</div><div class="line">  var files = fs.readdirSync(path);</div><div class="line">  files.forEach(function (itm) &#123;</div><div class="line">    var obj = &#123;&#125;;//定义一个对象存放文件的路径和名字</div><div class="line">    obj.path = path;//路径</div><div class="line">    obj.filename = itm//名字</div><div class="line">    filesList.push(obj);</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line">var getFiles = &#123;</div><div class="line">  //获取文件夹下的所有文件</div><div class="line">  getFileList: function (path) &#123;</div><div class="line">      var filesList = [];</div><div class="line">      readFileList(path, filesList);</div><div class="line">      return filesList;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">let files = getFiles.getFileList(&quot;./content/&quot;)  //拿到a,b这一级别文件</div><div class="line">for(let i=0;i&lt;files.length;i++)&#123;</div><div class="line">  let filepath = files[i].path+files[i].filename+&apos;/&apos; //拼接a,b路径</div><div class="line">  let images = getFiles.getFileList(filepath)  //拿到a,b下一级的文件，即所有图片</div><div class="line">  let imgpath = filepath+&apos;images&apos;</div><div class="line">  fs.mkdirSync(imgpath);//新建文件夹</div><div class="line">  for(let j = 0;j&lt;images.length;j++)&#123; //将图片移到新文件夹中</div><div class="line">    let oldpath = images[j].path+images[j].filename</div><div class="line">    let newpath = imgpath+&apos;/&apos;+images[j].filename</div><div class="line">    fs.rename(oldpath,newpath,function(err)&#123;</div><div class="line">      console.log(err)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="转义文件"><a href="#转义文件" class="headerlink" title="转义文件"></a>转义文件</h3><p>因为原项目为单页面文件，无法进行爬虫批量获取<br>最终实现也还是手动copy页面中dom,一个页面一个页面的copy<br>然后处理</p>
<p>安装转义包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install html-to-md</div></pre></td></tr></table></figure></p>
<p>开始使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">const html2md=require(&apos;html-to-md&apos;)</div><div class="line">const fs = require(&apos;fs&apos;);</div><div class="line">//在页面中找到使用说明的dom,copy之后存放到temp.txt中</div><div class="line">//当做字符串被读取</div><div class="line">var contentText = fs.readFileSync(&apos;temp.txt&apos;,&apos;utf-8&apos;);</div><div class="line">let res = html2md(contentText)</div><div class="line">//匹配md的‘[]()’书写形式</div><div class="line">let reg1=/\[([\S ]*?)]\s?()\( *&lt;?([^\s&apos;&quot;]*?(?:\([\S]*?\)[\S]*?)?)&gt;?\s*(?:()([&apos;&quot;])(.*?)\5)? *\)/g</div><div class="line">//匹配md的‘![]()’书写形式</div><div class="line">let reg2 = /!\[([^\]]*?)][ \t]*()\([ \t]?&lt;?([\S]+?(?:\([\S]*?\)[\S]*?)?)&gt;?(?: =([*\d]+[A-Za-z%]&#123;0,4&#125;)x([*\d]+[A-Za-z%]&#123;0,4&#125;))?[ \t]*(?:([&quot;&apos;])([^&quot;]*?)\6)?[ \t]?\)/g</div><div class="line">//在每篇开头注入转义规则front matter</div><div class="line">res = &apos;---\nsidebarDepth: 2 \nancherShow: true \nancherLevel: h3 \n--- \n&apos; + res.replace(reg1,function(group,text)&#123; //html-to-md包转义结果将标题转移成没有连接但有连接名的书写形式[xxx](),所以这里将其替换成 md写法</div><div class="line">  return text?&apos;## &apos;+text:group</div><div class="line">&#125;).replace(reg2,function(...res)&#123; //将图片引用路径做统一处理</div><div class="line">  let arr =  res[3].slice(res[3].lastIndexOf(&apos;/&apos;)+1).split(&apos;.&apos;)</div><div class="line">  return &apos;![](./images/&apos;+arr[0]+&apos;.&apos;+arr[2]+&apos;)&apos;</div><div class="line">&#125;)</div><div class="line">//将处理后的文件写入相应的文件夹中的manual.md文件中，即生成md文件</div><div class="line">fs.writeFile(&quot;./content/xxxx/manual.md&quot;, res, function(err) &#123; </div><div class="line">  if(err) &#123;</div><div class="line">      return console.log(err);</div><div class="line">  &#125;</div><div class="line">  console.log(&quot;The file was saved!&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>所以最终文件夹目录为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">--content</div><div class="line">  --a</div><div class="line">    --images</div><div class="line">    --manual.md</div><div class="line">  --b</div><div class="line">    --images</div><div class="line">    --manual.md</div></pre></td></tr></table></figure></p>
<p>现在将content目录下文件全都粘贴到docs文件夹下面，与.vuepres平级<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--docs</div><div class="line">  --.vuepress</div><div class="line">  --a</div><div class="line">    --images</div><div class="line">    --manual.md</div><div class="line">  --b</div><div class="line">    --images</div><div class="line">    --manual.md</div></pre></td></tr></table></figure></p>
<p>就可以在.vuepress文件夹下面的config.js中配置sidebar了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> sidebar: [</div><div class="line">      &#123;</div><div class="line">        title: &apos;产品a&apos;,</div><div class="line">        collapsable: true,</div><div class="line">        children:[</div><div class="line">            [&apos;/a/manual.md&apos;, &apos;a操作手册&apos;],</div><div class="line">          ]</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>1.如何将公共开源的项目更契合的应用到公司级项目，对原项目的破坏是避免不了的，比如替换主题颜色，替换相关图标，以及为了新增一些原来项目中没有的功能，而去更改原有处理逻辑，所谓二次开发，实质上，可能应该叫破坏性开发，不遵循原来的使用规则，在原来基础上，造自己的规则</p>
<p>2.对于大批量重复性工作的处理，要学会使用工具，<br>比如局部大量替换，借助vscode的局部锁定（先选取范围再点击下图1，锁定按钮）<br>再比如规则类似的替换，又要善于利用vscode的正则匹配去替换，如下图2<br><img src="/image/vscode.png" alt="vscode"><br>如果属于大规模处理，还要学会自己造工具<br>比如上述批量处理目录结构，改造md文件<br>人之所以为人，学会使用工具才能算是进入了文明社会</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/knowledge/editionproblem.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/knowledge/editionproblem.html" itemprop="url">
                  一个发版问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-19T16:17:37+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>用户正在使用某个页面期间，后台发布新的版本，用户再切换其他页面，<br>浏览器会报一个资源找不到的error,导致页面崩溃</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>最终发布的版本会经过打包处理，每次打包的产物，文件名会不同<br>新发布的版本是最新打包的结果，上个版本发布的是上次发版前的结果<br>后台发布到服务器的项目新版本不再包含上个版本发布的文件<br>即服务器仅有新版本的文件<br>如果触发切换页面，此时浏览器向服务器发起请求上个版本的文件<br>服务器仅有最新版本文件，不再包含上个版本文件<br>故返回404，浏览器崩溃</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>使用vue框架编写项目，使用vue-router进行路由切换</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h2 id="利用路由"><a href="#利用路由" class="headerlink" title="利用路由"></a>利用路由</h2><p>在路由生命钩子函数中添加onerror的处理，<br>让当前页面重新load一下，把资源拉回来，再让用户自己去点击要切换的页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.onError((error) =&gt; &#123;</div><div class="line">  const pattern = /Loading chunk (\d)+ failed/g</div><div class="line">  const isChunkLoadFailed = error.message.match(pattern)</div><div class="line">  if (isChunkLoadFailed) &#123;</div><div class="line">    $Message(&apos;系统更新，页面将进行刷新操作！&apos;)</div><div class="line">    window.location.reload()</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h2 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h2><p>使用webpack打包的时候生成一个hash.json的文件，然后前端轮询，<br>发现hash改变，就弹窗提示用户进行更新</p>
<h2 id="借助CDN缓存策略"><a href="#借助CDN缓存策略" class="headerlink" title="借助CDN缓存策略"></a>借助CDN缓存策略</h2><p>发版代码放到cdn上，用户未进行任何刷新操作则仍使用老代码，<br>用户进行了手动刷新，则拿到最新版本，进入新页面</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vueroutersrc.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vueroutersrc.html" itemprop="url">
                  vueRouter 源码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-19T10:48:15+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">  &lt;div id = &apos;app&apos; class=&apos;hello&apos;&gt;</div><div class="line">    &lt;p&gt;</div><div class="line">      &lt;router-link to=&quot;/foo&quot;&gt;Go to Foo&lt;/router-link&gt;</div><div class="line">      &lt;router-link to=&quot;/bar/user&quot;&gt;Go to Bar&lt;/router-link&gt;</div><div class="line">    &lt;/p&gt;</div><div class="line">    &lt;router-view&gt;&lt;/router-view&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;vue.js&quot;&gt;&lt;/script&gt;</div><div class="line">  &lt;script type=&quot;text/javascript&quot; src=&quot;vue-router.js&quot;&gt;&lt;/script&gt;</div><div class="line">  &lt;script&gt;</div><div class="line">    const Foo = &#123; template: &apos;&lt;div&gt;foo&lt;/div&gt;&apos;,mounted()&#123;&#125;&#125;//路由foo组件</div><div class="line">    const Bar = &#123; </div><div class="line">      template: &apos;&lt;div&gt;bar&lt;div&gt;&#123;&#123;id&#125;&#125;&lt;/div&gt;&lt;a @click=&quot;aa&quot;&gt;go to foo&lt;/a&gt;&lt;/div&gt;&apos;,//路由bar组件</div><div class="line">      data()&#123;</div><div class="line">        return &#123;</div><div class="line">          id:&apos;&apos;,</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      methods:&#123;</div><div class="line">        aa()&#123;</div><div class="line">          console.log(this.$router)</div><div class="line">          this.$router.push(&#123;name:&apos;foo&apos;,params:&#123;name:&apos;jck&apos;&#125;&#125;)</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      mounted()&#123;</div><div class="line">        console.log(this.$route,this.$router)</div><div class="line">        this.id = this.$route.params.id</div><div class="line">      &#125; </div><div class="line">      &#125;</div><div class="line">    const routes = [</div><div class="line">        &#123; path: &apos;/foo/:name&apos;,name:&apos;foo&apos;, component: Foo &#125;,</div><div class="line">        &#123; path: &apos;/bar/:id?&apos;,name:&apos;bar&apos;, component: Bar &#125;</div><div class="line">      ]</div><div class="line">    const router = new VueRouter(&#123;routes&#125;)</div><div class="line">    let app = new Vue(&#123;</div><div class="line">      el:&apos;#app&apos;,</div><div class="line">      data:&#123;&#125;,</div><div class="line">      method:&#123;&#125;,</div><div class="line">      router,</div><div class="line">    &#125;)</div><div class="line">  &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h1 id="执行vue-Router-js文件"><a href="#执行vue-Router-js文件" class="headerlink" title="执行vue-Router.js文件"></a>执行vue-Router.js文件</h1><p>引入vue-router之前会先引入vue.js文件，执行会生成vue构造函数,<br>因为vue-router的执行过程会用到vue构造函数这个对象上的方法<br>当代码引入vue-router.js时，里面相应的代码会执行一遍，<br>此时vue构造函数已经生成<br>所以vue-router.js运行后，<br>不仅会生成vue-router的构造对象<br>还会调用vue构造函数上的use方法将与router相关的信息挂到vue构造函数对象上<br>即做一些注册挂载的初始化工作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">(function (global, factory) &#123;</div><div class="line">  global.VueRouter = factory());</div><div class="line">&#125;(this, function () &#123; &apos;use strict&apos;;</div><div class="line">  //vue-router的构造对象</div><div class="line">  var VueRouter = function VueRouter (options) &#123; </div><div class="line">    if ( options === void 0 ) options = &#123;&#125;;</div><div class="line">    //options即new vueRouter时传进来的参数对象，这里只有一个属性即路由配置对象routes</div><div class="line">    this.app = null;</div><div class="line">    this.apps = [];</div><div class="line">    this.options = options;</div><div class="line">    this.beforeHooks = [];</div><div class="line">    this.resolveHooks = [];</div><div class="line">    this.afterHooks = [];</div><div class="line">    //该函数会根据路由配合生成路由表，返回两个函数，一个match函数用来匹配路由，另一个addRoutes用来动态增加路由，详见下文具体分析</div><div class="line">    this.matcher = createMatcher(options.routes || [], this);</div><div class="line">    var mode = options.mode || &apos;hash&apos;;//路由对象模式，没有配置的话默认初始化为&apos;hash&apos;</div><div class="line">    //fallback参数用于配置当浏览器不支持 history.pushState 控制路由是否应该回退到 hash 模式</div><div class="line">    //默认值为 true 官文：https://router.vuejs.org/zh/api/#fallback</div><div class="line">    this.fallback = mode === &apos;history&apos; &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false;</div><div class="line">    if (this.fallback) &#123; //history模式下在不支持pushstate方法且配置允许回退hash的情况下回退hash模式</div><div class="line">      mode = &apos;hash&apos;;</div><div class="line">    &#125;</div><div class="line">    if (!inBrowser) &#123; //没有在浏览器中，那应该是在nodejs中，模式重置为abstract</div><div class="line">      mode = &apos;abstract&apos;;</div><div class="line">    &#125;</div><div class="line">    this.mode = mode;//模式确定</div><div class="line"></div><div class="line">    switch (mode) &#123; //初始化history对象，三种类型的history构造函数继承自同一父类构造函数History</div><div class="line">      case &apos;history&apos;:</div><div class="line">        this.history = new HTML5History(this, options.base);</div><div class="line">        break</div><div class="line">      case &apos;hash&apos;:</div><div class="line">        this.history = new HashHistory(this, options.base, this.fallback);</div><div class="line">        break</div><div class="line">      case &apos;abstract&apos;:</div><div class="line">        this.history = new AbstractHistory(this, options.base);</div><div class="line">        break</div><div class="line">      default:</div><div class="line">        &#123;</div><div class="line">          assert(false, (&quot;invalid mode: &quot; + mode));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  VueRouter.install = install;</div><div class="line">  VueRouter.version = &apos;3.1.5&apos;;</div><div class="line"></div><div class="line">  function install (Vue) &#123; &#125; //挂到VueRouter上，被vue.use函数调用</div><div class="line"></div><div class="line">  if (inBrowser &amp;&amp; window.Vue) &#123; //只在浏览器环境自动挂载，说明在node.js中需要自己调用Vue.use手动挂载</div><div class="line">    window.Vue.use(VueRouter);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return VueRouter;</div><div class="line"></div><div class="line">&#125;));</div></pre></td></tr></table></figure></p>
<h2 id="vue-use-与-VueRouter-install"><a href="#vue-use-与-VueRouter-install" class="headerlink" title="vue.use 与 VueRouter.install"></a>vue.use 与 VueRouter.install</h2><p>vue的use方法会调用插件的install方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//在运行initGlobalAPI(Vue)函数时调用initUse挂载到VUE上</div><div class="line">Vue.use = function (plugin) &#123;</div><div class="line">  var installedPlugins = (this._installedPlugins || (this._installedPlugins = []));//this是指Vue哦</div><div class="line">  if (installedPlugins.indexOf(plugin) &gt; -1) &#123; //避免重复挂载</div><div class="line">    return this</div><div class="line">  &#125;</div><div class="line">  //这个方法会从arguments中取出从第一个数以后的所有参数，这里返回空数组===&gt;[]</div><div class="line">  var args = toArray(arguments, 1);</div><div class="line">  args.unshift(this);//this是vue,将vue传给组件进行初始化 ==&gt;[vue]</div><div class="line">  if (typeof plugin.install === &apos;function&apos;) &#123;  //组件定义了plugin.install方法，执行组件plugin.install方法</div><div class="line">    plugin.install.apply(plugin, args);</div><div class="line">  &#125; else if (typeof plugin === &apos;function&apos;) &#123; //没定义定义plugin.install方法且组件本身是函数，则调用自身</div><div class="line">    plugin.apply(null, args);</div><div class="line">  &#125;</div><div class="line">  installedPlugins.push(plugin);//将插件推入vue对象上的installedPlugins集合中</div><div class="line">  return this</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>VueRouter.install方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">function install (Vue) &#123; //挂到VueRouter上，被vue.use函数调用</div><div class="line">    if (install.installed &amp;&amp; _Vue === Vue) &#123; return &#125;//避免重复挂载</div><div class="line">    install.installed = true;</div><div class="line"></div><div class="line">    _Vue = Vue;</div><div class="line"></div><div class="line">    var isDef = function (v) &#123; return v !== undefined; &#125;;</div><div class="line"></div><div class="line">    var registerInstance = function (vm, callVal) &#123;</div><div class="line">      var i = vm.$options._parentVnode;</div><div class="line">      if (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) &#123;</div><div class="line">        i(vm, callVal);//如果定义了registerRouteInstance就执行</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    //调用vue.mixin方法 将beforeCreate 和 destroyed，两个生命周期函数存到到对应的钩子函数的集合中</div><div class="line">    //在执行new vue时会调用callHook执行 beforeCreate相关的钩子函数</div><div class="line">    //在vue中执行destroyed钩子函数时，同样也会调用这里定义好的生命周期函数</div><div class="line">    Vue.mixin(&#123; </div><div class="line">      beforeCreate: function beforeCreate () &#123; //这里this指向vue</div><div class="line">        if (isDef(this.$options.router)) &#123;</div><div class="line">          this._routerRoot = this;</div><div class="line">          this._router = this.$options.router;</div><div class="line">          //调用vueRouter对象上的init方法,主要功能是初始化当前路由，设置监听 详见下文</div><div class="line">          this._router.init(this);</div><div class="line">          Vue.util.defineReactive(this, &apos;_route&apos;, this._router.history.current);</div><div class="line">          //defineReactive会对数据进行劫持，进行依赖收集，方便之后页面切换进行监听</div><div class="line">        &#125; else &#123;//如果没有在new vue时传进vuerouter对象</div><div class="line">          this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this;</div><div class="line">        &#125;</div><div class="line">        registerInstance(this, this);</div><div class="line">      &#125;,</div><div class="line">      destroyed: function destroyed () &#123;</div><div class="line">        registerInstance(this);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">    //访问this.$router,返回new vueRouter生成的对象</div><div class="line">    Object.defineProperty(Vue.prototype, &apos;$router&apos;, &#123; </div><div class="line">      get: function get () &#123; return this._routerRoot._router &#125;</div><div class="line">    &#125;);</div><div class="line">    //访问this.$route,当前页面路由对象 this._router.history.current</div><div class="line">    Object.defineProperty(Vue.prototype, &apos;$route&apos;, &#123;</div><div class="line">      get: function get () &#123; return this._routerRoot._route &#125;</div><div class="line">    &#125;);</div><div class="line">    //挂载RouterView，RouterLink两个组件</div><div class="line">    Vue.component(&apos;RouterView&apos;, View); </div><div class="line">    Vue.component(&apos;RouterLink&apos;, Link);</div><div class="line">    //使用vue生命钩子函数合并策略定义路由生命周期钩子函数合并策略 其实就是mergeHook函数</div><div class="line">    var strats = Vue.config.optionMergeStrategies;</div><div class="line">    // use the same hook merging strategy for route hooks</div><div class="line">    strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>vueRouter在执行阶段会做以下两件事<br>1.生成vue-router的构造对象<br>2.挂载vuerouter相关信息到vue对象</p>
<p>挂载到vue对象时会做以下几件事<br>1.注入两个生命周期函数：beforeCreate和 destroyed<br>2.指定vue的$router和$route分别指向传进去的vueRouter对象的本身和history.current属性<br>3.挂载RouterView,RouterLink两个组件<br>4.指定路由生命周期函数合并策略使用vue中生命周期函数的合并策略</p>
<p>beforeCreate会在new vue时被调用，主要做以下几件事<br>1.在vue对象上指定与router相关的属性<br>2.调用vuerouter的init方法，初始化当前路由，设置监听<br>3.对当前路由进行数据劫持，进行监听</p>
<p>在new vueRouter时，会做以下几件事<br>1.根据路由配置数组生成路由表，匹配函数以及动态增加路由的函数<br>2.确定路由模式<br>3。根据路由模式创建history属性</p>
<h1 id="一个疑惑"><a href="#一个疑惑" class="headerlink" title="一个疑惑"></a>一个疑惑</h1><p>当跳转的路由带有query或者params时，将其中的值插入到页面中为什么不会引起XSS攻击？<br>因为拿到的值类型都是原始js类型，vue在替换值时只是当做字符串替换，不会进行innerHTML</p>
<h2 id="使用js跳转路由"><a href="#使用js跳转路由" class="headerlink" title="使用js跳转路由"></a>使用js跳转路由</h2><p>比如this.$router.push({name:foo,query:{id:1}})方法跳转路由<br>目的页面拿到的query/params数据，就是调用push函数传入的数据<br>当我们调用push函数时，就是在调用这段代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">VueRouter.prototype.push = function push (location, onComplete, onAbort) &#123;</div><div class="line">    var this$1 = this;</div><div class="line">    if (!onComplete &amp;&amp; !onAbort &amp;&amp; typeof Promise !== &apos;undefined&apos;) &#123;</div><div class="line">      return new Promise(function (resolve, reject) &#123;//进行异步跳转</div><div class="line">        this$1.history.push(location, resolve, reject);</div><div class="line">      &#125;)</div><div class="line">    &#125; else &#123;//进行同步跳转</div><div class="line">      this.history.push(location, onComplete, onAbort);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div></pre></td></tr></table></figure></p>
<p>location就是我们传入的参数，没有传入 onComplete, onAbort，所以会进入if分支<br>可见无论进入哪个分支都会调用history对象的push方法<br>由于在new VueRouter对象时，在构造函数中history是根据传入的选项生成的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">var mode = options.mode || &apos;hash&apos;;</div><div class="line">  this.fallback = mode === &apos;history&apos; &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false;</div><div class="line">  if (this.fallback) &#123;</div><div class="line">    mode = &apos;hash&apos;;</div><div class="line">  &#125;</div><div class="line">  if (!inBrowser) &#123;</div><div class="line">    mode = &apos;abstract&apos;;</div><div class="line">  &#125;</div><div class="line">  this.mode = mode;</div><div class="line"></div><div class="line">  switch (mode) &#123;</div><div class="line">    case &apos;history&apos;:</div><div class="line">      this.history = new HTML5History(this, options.base);</div><div class="line">      break</div><div class="line">    case &apos;hash&apos;:</div><div class="line">      this.history = new HashHistory(this, options.base, this.fallback);</div><div class="line">      break</div><div class="line">    case &apos;abstract&apos;:</div><div class="line">      this.history = new AbstractHistory(this, options.base);</div><div class="line">      break</div><div class="line">    default:</div><div class="line">      &#123;</div><div class="line">        assert(false, (&quot;invalid mode: &quot; + mode));</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>所以push方法的实现可能为以下三种情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">HTML5History.prototype.push = function push (location, onComplete, onAbort) &#123;</div><div class="line">  var this$1 = this;</div><div class="line"></div><div class="line">  var ref = this;</div><div class="line">  var fromRoute = ref.current;</div><div class="line">  this.transitionTo(location, function (route) &#123;</div><div class="line">    pushState(cleanPath(this$1.base + route.fullPath));</div><div class="line">    handleScroll(this$1.router, route, fromRoute, false);</div><div class="line">    onComplete &amp;&amp; onComplete(route);</div><div class="line">  &#125;, onAbort);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">HashHistory.prototype.push = function push (location, onComplete, onAbort) &#123;</div><div class="line">  var this$1 = this;</div><div class="line">  var ref = this;</div><div class="line">  var fromRoute = ref.current;</div><div class="line">  this.transitionTo(</div><div class="line">    location,</div><div class="line">    function (route) &#123;</div><div class="line">      pushHash(route.fullPath);//更改url</div><div class="line">      handleScroll(this$1.router, route, fromRoute, false);</div><div class="line">      onComplete &amp;&amp; onComplete(route);</div><div class="line">    &#125;,</div><div class="line">    onAbort</div><div class="line">  );</div><div class="line">&#125;;</div><div class="line">AbstractHistory.prototype.push = function push (location, onComplete, onAbort) &#123;</div><div class="line">  var this$1 = this;</div><div class="line">  this.transitionTo(</div><div class="line">    location,</div><div class="line">    function (route) &#123;</div><div class="line">      this$1.stack = this$1.stack.slice(0, this$1.index + 1).concat(route);</div><div class="line">      this$1.index++;</div><div class="line">      onComplete &amp;&amp; onComplete(route);</div><div class="line">    &#125;,</div><div class="line">    onAbort</div><div class="line">  );</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>可见三种模式下都会调用共同的父类History上的transitionTo方法<br>接下来以HashHistory为基础分析接下来的流程</p>
<p>在HashHistory push调用transitionTo时，<br>传入三个参数：<br>location 即我们调用push时传入的参数<br>onAbort 调用push时没有传入，故该值为undefined<br>第三个参数是一个匿名函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">function (route) &#123;</div><div class="line">  pushHash(route.fullPath);//更改url</div><div class="line">  handleScroll(this$1.router, route, fromRoute, false);//处理页面滚动相关功能</div><div class="line">  onComplete &amp;&amp; onComplete(route);//调用push时没有传入onComplete,故onComplete=&gt;undefined,不会被执行</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>可见匿名函数内将来要执行pushHash函数</p>
<h3 id="pushHash函数更改浏览器url"><a href="#pushHash函数更改浏览器url" class="headerlink" title="pushHash函数更改浏览器url"></a>pushHash函数更改浏览器url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">function pushHash (path) &#123;</div><div class="line">  if (supportsPushState) &#123; 使用history.pushState更改URl</div><div class="line">    pushState(getUrl(path));</div><div class="line">  &#125; else &#123;//如果不支持history.pushState则直接更改hash值</div><div class="line">    window.location.hash = path;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">function getUrl (path) &#123;</div><div class="line">  var href = window.location.href;</div><div class="line">  var i = href.indexOf(&apos;#&apos;);</div><div class="line">  var base = i &gt;= 0 ? href.slice(0, i) : href;</div><div class="line">  return (base + &quot;#&quot; + path)</div><div class="line">&#125;</div><div class="line">function pushState (url, replace) &#123;</div><div class="line">  saveScrollPosition();</div><div class="line">  // try...catch the pushState call to get around Safari</div><div class="line">  // DOM Exception 18 where it limits to 100 pushState calls</div><div class="line">  var history = window.history;</div><div class="line">  try &#123;</div><div class="line">    if (replace) &#123; //在使用replace函数跳转路由会走该分支，由replaceState函数调用，replace传入为true</div><div class="line">      // 保留现有的历史记录状态，因为用户可能会覆盖它</div><div class="line">      var stateCopy = extend(&#123;&#125;, history.state);</div><div class="line">      stateCopy.key = getStateKey();</div><div class="line">      history.replaceState(stateCopy, &apos;&apos;, url); //使用window的history上的方法</div><div class="line">    &#125; else &#123; //没有传入replace，故进入该分支</div><div class="line">      history.pushState(&#123; key: setStateKey(genStateKey()) &#125;, &apos;&apos;, url);</div><div class="line">    &#125;</div><div class="line">  &#125; catch (e) &#123;</div><div class="line">    window.location[replace ? &apos;replace&apos; : &apos;assign&apos;](url);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以pushHash函数最终的目的是更改浏览器中的url<br>handleScroll函数处理页面滚动状态，这里暂不做深入<br>onComplete 值为undefined,故不执行</p>
<h3 id="transitionTo"><a href="#transitionTo" class="headerlink" title="transitionTo"></a>transitionTo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">History.prototype.transitionTo = function transitionTo (</div><div class="line">    location,</div><div class="line">    onComplete,</div><div class="line">    onAbort</div><div class="line">  ) &#123;</div><div class="line">    var this$1 = this;</div><div class="line">    var route = this.router.match(location, this.current);//得到目的路由的route对象</div><div class="line">    this.confirmTransition(...暂时省略));</div><div class="line">  &#125;;</div></pre></td></tr></table></figure>
<p>transitionTo函数中第一步就是根据根据当前路由信息和传入的目的路由信息生成目的路由对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var route = this.router.match(location, this.current);</div></pre></td></tr></table></figure></p>
<p>location 是我们调用push函数传入的参数，<br>this.current即当前页面路由信息对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">VueRouter.prototype.match = function match (</div><div class="line">  raw,</div><div class="line">  current,</div><div class="line">  redirectedFrom</div><div class="line">) &#123;</div><div class="line">  return this.matcher.match(raw, current, redirectedFrom)</div><div class="line">&#125;;</div><div class="line"></div><div class="line">this.matcher = createMatcher(options.routes || [], this); //new vuerouter时在构造函数中生成</div></pre></td></tr></table></figure>
<h3 id="createMatcher"><a href="#createMatcher" class="headerlink" title="createMatcher"></a>createMatcher</h3><p>createMatcher函数即创造匹配器的函数，主要做三件事<br>1.生成路由表<br>2.生成匹配器，用于将当然路由对象和目的路由信息对象合成目的路由对象<br>3.生成动态添加路由的函数，因这里可以直接使用路由表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">function createMatcher (</div><div class="line">  routes,</div><div class="line">  router</div><div class="line">) &#123;</div><div class="line">  var ref = createRouteMap(routes);//根据路由配置生成路由表</div><div class="line">  var pathList = ref.pathList;</div><div class="line">  var pathMap = ref.pathMap;</div><div class="line">  var nameMap = ref.nameMap;</div><div class="line"></div><div class="line">  function addRoutes (routes) &#123; //动态增加路由</div><div class="line">    createRouteMap(routes, pathList, pathMap, nameMap);</div><div class="line">  &#125;</div><div class="line">  //根据当前路由对象和目的路由信息以及是否重定向等条件合成目的路由对象返回</div><div class="line">  function match ( </div><div class="line">    raw,</div><div class="line">    currentRoute,</div><div class="line">    redirectedFrom</div><div class="line">  ) &#123;</div><div class="line">    //统一路由参数，合并params给到目的路由</div><div class="line">    var location = normalizeLocation(raw, currentRoute, false, router);</div><div class="line">    var name = location.name;</div><div class="line">    if (name) &#123;//走这条分支</div><div class="line">      var record = nameMap[name];</div><div class="line">      &#123;</div><div class="line">        warn(record, (&quot;Route with name &apos;&quot; + name + &quot;&apos; does not exist&quot;));</div><div class="line">      &#125;</div><div class="line">      if (!record) &#123; return _createRoute(null, location) &#125;</div><div class="line">      var paramNames = record.regex.keys //没有在路由path中配置动态参数，keys数组为空</div><div class="line">        .filter(function (key) &#123; return !key.optional; &#125;)</div><div class="line">        .map(function (key) &#123; return key.name; &#125;);</div><div class="line"></div><div class="line">      if (typeof location.params !== &apos;object&apos;) &#123;</div><div class="line">        location.params = &#123;&#125;; //给location 挂上params</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      if (currentRoute &amp;&amp; typeof currentRoute.params === &apos;object&apos;) &#123;</div><div class="line">        for (var key in currentRoute.params) &#123;//params中有相同key值时，从当前路由将值给到目的路由</div><div class="line">          if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) &gt; -1) &#123;</div><div class="line">            location.params[key] = currentRoute.params[key];</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      //如果path有动态参数，使用params将path补全，//以name发起的跳转，挂上了path</div><div class="line">      location.path = fillParams(record.path, location.params, (&quot;named route \&quot;&quot; + name + &quot;\&quot;&quot;));</div><div class="line">      return _createRoute(record, location, redirectedFrom) 可知返回一route对象</div><div class="line">    &#125; else if (location.path) &#123; //详见link跳转分析</div><div class="line">      location.params = &#123;&#125;;</div><div class="line">      for (var i = 0; i &lt; pathList.length; i++) &#123;</div><div class="line">        var path = pathList[i];</div><div class="line">        var record$1 = pathMap[path];</div><div class="line">        if (matchRoute(record$1.regex, location.path, location.params)) &#123;</div><div class="line">          console.log(location)</div><div class="line">          return _createRoute(record$1, location, redirectedFrom)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    // no match</div><div class="line">    return _createRoute(null, location)</div><div class="line">  &#125;</div><div class="line">  function redirect () &#123;...对重定向一系列的处理，会返回createRoute()&#125;</div><div class="line">  function alias () &#123;...对路由配置中的别名进行处理，会返回createRoute()&#125;</div><div class="line">  function _createRoute ( //会生成fullpath</div><div class="line">    record,</div><div class="line">    location,</div><div class="line">    redirectedFrom</div><div class="line">  ) &#123;</div><div class="line">    if (record &amp;&amp; record.redirect) &#123;</div><div class="line">      return redirect(record, redirectedFrom || location)</div><div class="line">    &#125;</div><div class="line">    if (record &amp;&amp; record.matchAs) &#123;</div><div class="line">      return alias(record, location, record.matchAs)</div><div class="line">    &#125;</div><div class="line">    return createRoute(record, location, redirectedFrom, router)</div><div class="line">  &#125;</div><div class="line">  return &#123;</div><div class="line">    match: match,</div><div class="line">    addRoutes: addRoutes</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="路由表生成"><a href="#路由表生成" class="headerlink" title="路由表生成"></a>路由表生成</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">function createRouteMap ( //生成路由表</div><div class="line">  routes,</div><div class="line">  oldPathList,</div><div class="line">  oldPathMap,</div><div class="line">  oldNameMap</div><div class="line">) &#123;</div><div class="line">  // the path list is used to control path matching priority</div><div class="line">  var pathList = oldPathList || [];</div><div class="line">  // $flow-disable-line</div><div class="line">  var pathMap = oldPathMap || Object.create(null);</div><div class="line">  // $flow-disable-line</div><div class="line">  var nameMap = oldNameMap || Object.create(null);</div><div class="line"></div><div class="line">  routes.forEach(function (route) &#123;</div><div class="line">    addRouteRecord(pathList, pathMap, nameMap, route);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  // ensure wildcard(通配符) routes are always at the end</div><div class="line">  for (var i = 0, l = pathList.length; i &lt; l; i++) &#123;</div><div class="line">    if (pathList[i] === &apos;*&apos;) &#123;</div><div class="line">      pathList.push(pathList.splice(i, 1)[0]);</div><div class="line">      l--;</div><div class="line">      i--;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    // warn if routes do not include leading slashes(斜线)</div><div class="line">    var found = pathList</div><div class="line">    // check for missing leading slash</div><div class="line">      .filter(function (path) &#123; return path &amp;&amp; path.charAt(0) !== &apos;*&apos; &amp;&amp; path.charAt(0) !== &apos;/&apos;; &#125;);</div><div class="line"></div><div class="line">    if (found.length &gt; 0) &#123;</div><div class="line">      var pathNames = found.map(function (path) &#123; return (&quot;- &quot; + path); &#125;).join(&apos;\n&apos;);</div><div class="line">      warn(false, (&quot;Non-nested routes must include a leading slash character. Fix the following routes: \n&quot; + pathNames));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  return &#123;</div><div class="line">    pathList: pathList,//数组，存放path值的集合</div><div class="line">    pathMap: pathMap,//对象，有配置path的路由record集合</div><div class="line">    nameMap: nameMap//对象，有配置name的路由record的集合</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">//根据配置的路由将其转换成内部使用的路由对象record,并根据配置情况放到不同路由集合(前三个参数)中，</div><div class="line">function addRouteRecord ( </div><div class="line">  pathList,</div><div class="line">  pathMap,</div><div class="line">  nameMap,</div><div class="line">  route,//具体配置的route</div><div class="line">  parent,//用于处理配置了children，被递归调用时传入，</div><div class="line">  matchAs</div><div class="line">) &#123;</div><div class="line">  var path = route.path;</div><div class="line">  var name = route.name;</div><div class="line"> </div><div class="line">  var pathToRegexpOptions =</div><div class="line">    route.pathToRegexpOptions || &#123;&#125;;</div><div class="line">  var normalizedPath = normalizePath(path, parent, pathToRegexpOptions.strict);</div><div class="line"></div><div class="line">  if (typeof route.caseSensitive === &apos;boolean&apos;) &#123;</div><div class="line">    pathToRegexpOptions.sensitive = route.caseSensitive;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  var record = &#123;</div><div class="line">    path: normalizedPath,</div><div class="line">    regex: compileRouteRegex(normalizedPath, pathToRegexpOptions),</div><div class="line">    components: route.components || &#123; default: route.component &#125;,</div><div class="line">    instances: &#123;&#125;,</div><div class="line">    name: name,</div><div class="line">    parent: parent,</div><div class="line">    matchAs: matchAs,</div><div class="line">    redirect: route.redirect,</div><div class="line">    beforeEnter: route.beforeEnter,</div><div class="line">    meta: route.meta || &#123;&#125;,</div><div class="line">    props:</div><div class="line">      route.props == null</div><div class="line">        ? &#123;&#125;</div><div class="line">        : route.components</div><div class="line">          ? route.props</div><div class="line">          : &#123; default: route.props &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  if (route.children) &#123;...&#125;</div><div class="line"></div><div class="line">  if (!pathMap[record.path]) &#123;</div><div class="line">    pathList.push(record.path);</div><div class="line">    pathMap[record.path] = record;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (route.alias !== undefined) &#123;...&#125;</div><div class="line"></div><div class="line">  if (name) &#123;</div><div class="line">    if (!nameMap[name]) &#123;</div><div class="line">      nameMap[name] = record;</div><div class="line">    &#125; else if ( !matchAs) &#123;</div><div class="line">      warn(</div><div class="line">        false,</div><div class="line">        &quot;Duplicate named routes definition: &quot; +</div><div class="line">          &quot;&#123; name: \&quot;&quot; + name + &quot;\&quot;, path: \&quot;&quot; + (record.path) + &quot;\&quot; &#125;&quot;</div><div class="line">      );</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="合并params"><a href="#合并params" class="headerlink" title="合并params"></a>合并params</h3><p>在match函数中首先会整理参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">function normalizeLocation (</div><div class="line">   raw,</div><div class="line">   current,</div><div class="line">   append,</div><div class="line">   router</div><div class="line"> ) &#123;</div><div class="line">   //link标签点击传入的raw是to标签指令的值， 为字符串</div><div class="line">   var next = typeof raw === &apos;string&apos; ? &#123; path: raw &#125; : raw;</div><div class="line">   // named target</div><div class="line">   if (next._normalized) &#123;//已经处理过</div><div class="line">     return next</div><div class="line">   &#125; else if (next.name) &#123; //当前调用push使用name标记路由，只会走这个分支</div><div class="line">     next = extend(&#123;&#125;, raw);</div><div class="line">     var params = next.params;</div><div class="line">     if (params &amp;&amp; typeof params === &apos;object&apos;) &#123;</div><div class="line">       next.params = extend(&#123;&#125;, params);</div><div class="line">     &#125;</div><div class="line">     return next</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   // relative params</div><div class="line">   if (!next.path &amp;&amp; next.params &amp;&amp; current) &#123;</div><div class="line">     next = extend(&#123;&#125;, next);</div><div class="line">     next._normalized = true;</div><div class="line">     var params$1 = extend(extend(&#123;&#125;, current.params), next.params);</div><div class="line">     if (current.name) &#123;</div><div class="line">       next.name = current.name;</div><div class="line">       next.params = params$1;</div><div class="line">     &#125; else if (current.matched.length) &#123;</div><div class="line">       var rawPath = current.matched[current.matched.length - 1].path;</div><div class="line">       next.path = fillParams(rawPath, params$1, (&quot;path &quot; + (current.path)));</div><div class="line">     &#125; else &#123;</div><div class="line">       warn(false, &quot;relative params navigation requires a current route.&quot;);</div><div class="line">     &#125;</div><div class="line">     return next</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   var parsedPath = parsePath(next.path || &apos;&apos;);</div><div class="line">   var basePath = (current &amp;&amp; current.path) || &apos;/&apos;;</div><div class="line">   var path = parsedPath.path</div><div class="line">     ? resolvePath(parsedPath.path, basePath, append || next.append)</div><div class="line">     : basePath;</div><div class="line"></div><div class="line">   var query = resolveQuery(</div><div class="line">     parsedPath.query,</div><div class="line">     next.query,</div><div class="line">     router &amp;&amp; router.options.parseQuery</div><div class="line">   );</div><div class="line"></div><div class="line">   var hash = next.hash || parsedPath.hash;</div><div class="line">   if (hash &amp;&amp; hash.charAt(0) !== &apos;#&apos;) &#123;</div><div class="line">     hash = &quot;#&quot; + hash;</div><div class="line">   &#125;</div><div class="line">   return &#123;</div><div class="line">     _normalized: true,</div><div class="line">     path: path,</div><div class="line">     query: query,</div><div class="line">     hash: hash</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="创建路由route对象"><a href="#创建路由route对象" class="headerlink" title="创建路由route对象"></a>创建路由route对象</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">function createRoute (</div><div class="line">  record,</div><div class="line">  location,</div><div class="line">  redirectedFrom,</div><div class="line">  router</div><div class="line">) &#123;</div><div class="line">  var stringifyQuery = router &amp;&amp; router.options.stringifyQuery;</div><div class="line"></div><div class="line">  var query = location.query || &#123;&#125;;</div><div class="line">  try &#123;</div><div class="line">    query = clone(query);</div><div class="line">  &#125; catch (e) &#123;&#125;</div><div class="line"></div><div class="line">  var route = &#123;</div><div class="line">    name: location.name || (record &amp;&amp; record.name),</div><div class="line">    meta: (record &amp;&amp; record.meta) || &#123;&#125;,</div><div class="line">    path: location.path || &apos;/&apos;,</div><div class="line">    hash: location.hash || &apos;&apos;,</div><div class="line">    query: query,//调用push函数传递进来的query，赋值时只能赋值js数据类型，拿到的也是js数据类型</div><div class="line">    params: location.params || &#123;&#125;,</div><div class="line">    fullPath: getFullPath(location, stringifyQuery),//生成fullPath</div><div class="line">    matched: record ? formatMatch(record) : []</div><div class="line">  &#125;;</div><div class="line">  if (redirectedFrom) &#123;</div><div class="line">    route.redirectedFrom = getFullPath(redirectedFrom, stringifyQuery);</div><div class="line">  &#125;</div><div class="line">  return Object.freeze(route) //禁止改动route对象</div><div class="line">&#125;</div><div class="line">function getFullPath ( //根据query生成fullPath</div><div class="line">    ref,</div><div class="line">    _stringifyQuery</div><div class="line">  ) &#123;</div><div class="line">    var path = ref.path;</div><div class="line">    var query = ref.query; if ( query === void 0 ) query = &#123;&#125;;</div><div class="line">    var hash = ref.hash; if ( hash === void 0 ) hash = &apos;&apos;;</div><div class="line"></div><div class="line">    var stringify = _stringifyQuery || stringifyQuery;</div><div class="line">    return (path || &apos;/&apos;) + stringify(query) + hash</div><div class="line">  &#125;</div><div class="line">//组装url上参数的部分</div><div class="line">function stringifyQuery (obj) &#123;</div><div class="line">  var res = obj ? Object.keys(obj).map(function (key) &#123;</div><div class="line">    var val = obj[key];</div><div class="line"></div><div class="line">    if (val === undefined) &#123;</div><div class="line">      return &apos;&apos;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (val === null) &#123;</div><div class="line">      return encode(key)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (Array.isArray(val)) &#123;</div><div class="line">      var result = [];</div><div class="line">      val.forEach(function (val2) &#123;</div><div class="line">        if (val2 === undefined) &#123;</div><div class="line">          return</div><div class="line">        &#125;</div><div class="line">        if (val2 === null) &#123;</div><div class="line">          result.push(encode(key));</div><div class="line">        &#125; else &#123;</div><div class="line">          result.push(encode(key) + &apos;=&apos; + encode(val2));</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">      return result.join(&apos;&amp;&apos;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return encode(key) + &apos;=&apos; + encode(val)</div><div class="line">  &#125;).filter(function (x) &#123; return x.length &gt; 0; &#125;).join(&apos;&amp;&apos;) : null;</div><div class="line">  return res ? (&quot;?&quot; + res) : &apos;&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以在调用完match之后会得到route,接着会调用confirmTransition</p>
<h3 id="confirmTransition"><a href="#confirmTransition" class="headerlink" title="confirmTransition"></a>confirmTransition</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line">在transitionTo调用时</div><div class="line">this.confirmTransition(</div><div class="line">  route,</div><div class="line">  function () &#123;</div><div class="line">    this$1.updateRoute(route);//更新router对象</div><div class="line">    onComplete &amp;&amp; onComplete(route);//调用transitionTo时传入的第二个参数函数，里面有pushHash来更改url</div><div class="line">    this$1.ensureURL();</div><div class="line"></div><div class="line">    // fire ready cbs once</div><div class="line">    if (!this$1.ready) &#123;</div><div class="line">      this$1.ready = true;</div><div class="line">      this$1.readyCbs.forEach(function (cb) &#123;</div><div class="line">        cb(route);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  function (err) &#123;</div><div class="line">    if (onAbort) &#123;</div><div class="line">      onAbort(err);</div><div class="line">    &#125;</div><div class="line">    if (err &amp;&amp; !this$1.ready) &#123;</div><div class="line">      this$1.ready = true;</div><div class="line">      this$1.readyErrorCbs.forEach(function (cb) &#123;</div><div class="line">        cb(err);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">);</div><div class="line"></div><div class="line">History.prototype.confirmTransition = function confirmTransition (route, onComplete, onAbort) &#123;</div><div class="line">  var this$1 = this;</div><div class="line"></div><div class="line">  var current = this.current;</div><div class="line">  var abort = function (err) &#123;</div><div class="line">    // after merging https://github.com/vuejs/vue-router/pull/2771 we</div><div class="line">    // When the user navigates through history through back/forward buttons</div><div class="line">    // we do not want to throw the error. We only throw it if directly calling</div><div class="line">    // push/replace. That&apos;s why it&apos;s not included in isError</div><div class="line">    if (!isExtendedError(NavigationDuplicated, err) &amp;&amp; isError(err)) &#123;</div><div class="line">      if (this$1.errorCbs.length) &#123;</div><div class="line">        this$1.errorCbs.forEach(function (cb) &#123;</div><div class="line">          cb(err);</div><div class="line">        &#125;);</div><div class="line">      &#125; else &#123;</div><div class="line">        warn(false, &apos;uncaught error during route navigation:&apos;);</div><div class="line">        console.error(err);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    onAbort &amp;&amp; onAbort(err);</div><div class="line">  &#125;;</div><div class="line">  if (</div><div class="line">    isSameRoute(route, current) &amp;&amp;</div><div class="line">    // in the case the route map has been dynamically appended to</div><div class="line">    route.matched.length === current.matched.length</div><div class="line">  ) &#123;</div><div class="line">    this.ensureURL();</div><div class="line">    return abort(new NavigationDuplicated(route))</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  var ref = resolveQueue(</div><div class="line">    this.current.matched,</div><div class="line">    route.matched</div><div class="line">  );</div><div class="line">    var updated = ref.updated;</div><div class="line">    var deactivated = ref.deactivated;</div><div class="line">    var activated = ref.activated;</div><div class="line"></div><div class="line">  var queue = [].concat(</div><div class="line">    // in-component leave guards</div><div class="line">    extractLeaveGuards(deactivated),</div><div class="line">    // global before hooks</div><div class="line">    this.router.beforeHooks,</div><div class="line">    // in-component update hooks</div><div class="line">    extractUpdateHooks(updated),</div><div class="line">    // in-config enter guards</div><div class="line">    activated.map(function (m) &#123; return m.beforeEnter; &#125;),</div><div class="line">    // async components</div><div class="line">    resolveAsyncComponents(activated)</div><div class="line">  );</div><div class="line"></div><div class="line">  this.pending = route;</div><div class="line">  var iterator = function (hook, next) &#123;</div><div class="line">    if (this$1.pending !== route) &#123;</div><div class="line">      return abort()</div><div class="line">    &#125;</div><div class="line">    try &#123;</div><div class="line">      hook(route, current, function (to) &#123;</div><div class="line">        if (to === false || isError(to)) &#123;</div><div class="line">          // next(false) -&gt; abort navigation, ensure current URL</div><div class="line">          this$1.ensureURL(true);</div><div class="line">          abort(to);</div><div class="line">        &#125; else if (</div><div class="line">          typeof to === &apos;string&apos; ||</div><div class="line">          (typeof to === &apos;object&apos; &amp;&amp;</div><div class="line">            (typeof to.path === &apos;string&apos; || typeof to.name === &apos;string&apos;))</div><div class="line">        ) &#123;</div><div class="line">          // next(&apos;/&apos;) or next(&#123; path: &apos;/&apos; &#125;) -&gt; redirect</div><div class="line">          abort();</div><div class="line">          if (typeof to === &apos;object&apos; &amp;&amp; to.replace) &#123;</div><div class="line">            this$1.replace(to);</div><div class="line">          &#125; else &#123;</div><div class="line">            this$1.push(to);</div><div class="line">          &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">          // confirm transition and pass on the value</div><div class="line">          next(to);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125; catch (e) &#123;</div><div class="line">      abort(e);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  runQueue(queue, iterator, function () &#123;</div><div class="line">    var postEnterCbs = [];</div><div class="line">    var isValid = function () &#123; return this$1.current === route; &#125;;</div><div class="line">    // wait until async components are resolved before</div><div class="line">    // extracting in-component enter guards</div><div class="line">    var enterGuards = extractEnterGuards(activated, postEnterCbs, isValid);</div><div class="line">    var queue = enterGuards.concat(this$1.router.resolveHooks);</div><div class="line">    runQueue(queue, iterator, function () &#123;</div><div class="line">      if (this$1.pending !== route) &#123;</div><div class="line">        return abort()</div><div class="line">      &#125;</div><div class="line">      this$1.pending = null;</div><div class="line">      onComplete(route);//所有需要运行的钩子函数运行完执行更改url,更新current,处理页面滚动</div><div class="line">      if (this$1.router.app) &#123;</div><div class="line">        this$1.router.app.$nextTick(function () &#123;</div><div class="line">          postEnterCbs.forEach(function (cb) &#123;</div><div class="line">            cb();</div><div class="line">          &#125;);</div><div class="line">        &#125;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"> function runQueue (queue, fn, cb) &#123;</div><div class="line">  var step = function (index) &#123;</div><div class="line">    if (index &gt;= queue.length) &#123;</div><div class="line">      cb();</div><div class="line">    &#125; else &#123;</div><div class="line">      if (queue[index]) &#123;</div><div class="line">        fn(queue[index], function () &#123;</div><div class="line">          step(index + 1);</div><div class="line">        &#125;);</div><div class="line">      &#125; else &#123;</div><div class="line">        step(index + 1);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">  step(0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">History.prototype.updateRoute = function updateRoute (route) &#123;</div><div class="line">  var prev = this.current;</div><div class="line">  this.current = route;</div><div class="line">  this.cb &amp;&amp; this.cb(route); //通知app更改_route属性值，即更改$route值</div><div class="line">  this.router.afterHooks.forEach(function (hook) &#123;</div><div class="line">    hook &amp;&amp; hook(route, prev);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line">this.cb在install的时候被定义如果获取</div><div class="line">History.prototype.listen = function listen (cb) &#123;</div><div class="line">  this.cb = cb;</div><div class="line">&#125;;</div><div class="line">//在new vue时被定义</div><div class="line">VueRouter.prototype.init = function init (app ) &#123;</div><div class="line">  history.listen(function (route) &#123;</div><div class="line">    this$1.apps.forEach(function (app) &#123;</div><div class="line">      app._route = route;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line">//install的时候</div><div class="line">function install (Vue) &#123;</div><div class="line">  Object.defineProperty(Vue.prototype, &apos;$route&apos;, &#123;</div><div class="line">    get: function get () &#123; return this._routerRoot._route &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="link标签跳转路由"><a href="#link标签跳转路由" class="headerlink" title="link标签跳转路由"></a>link标签跳转路由</h2><p>点击link标签时，根据绑定函数即可知道，同样会调用router.push<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">var router = this.$router;</div><div class="line">var current = this.$route;</div><div class="line">var ref = router.resolve(</div><div class="line">  this.to,</div><div class="line">  current,</div><div class="line">  this.append</div><div class="line">);</div><div class="line"></div><div class="line">var location = ref.location;</div><div class="line">var route = ref.route;</div><div class="line">var href = ref.href;</div><div class="line"></div><div class="line">var handler = function (e) &#123;</div><div class="line">  if (guardEvent(e)) &#123;</div><div class="line">    if (this$1.replace) &#123;</div><div class="line">      router.replace(location, noop);</div><div class="line">    &#125; else &#123;</div><div class="line">      router.push(location, noop);//push,直接走同步流程</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">var on = &#123; click: guardEvent &#125;;</div><div class="line">if (Array.isArray(this.event)) &#123;</div><div class="line">  this.event.forEach(function (e) &#123;</div><div class="line">    on[e] = handler;</div><div class="line">  &#125;);</div><div class="line">&#125; else &#123;</div><div class="line">  on[this.event] = handler;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，经过resolve处理过的to标签属性的值，会生成统一规范的后续需要使用的location,route<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">VueRouter.prototype.resolve = function resolve (</div><div class="line">  to,</div><div class="line">  current,</div><div class="line">  append</div><div class="line">) &#123;</div><div class="line">  current = current || this.history.current;</div><div class="line">  var location = normalizeLocation(</div><div class="line">    to,</div><div class="line">    current,</div><div class="line">    append,</div><div class="line">    this</div><div class="line">  );</div><div class="line">  var route = this.match(location, current);</div><div class="line">  var fullPath = route.redirectedFrom || route.fullPath;</div><div class="line">  var base = this.history.base;</div><div class="line">  var href = createHref(base, fullPath, this.mode);</div><div class="line">  return &#123;</div><div class="line">    location: location,</div><div class="line">    route: route,</div><div class="line">    href: href,</div><div class="line">    // for backwards compat</div><div class="line">    normalizedTo: location,</div><div class="line">    resolved: route</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>location 会在normalizeLocation中以第三个return的位置返回如下结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  _normalized: true,</div><div class="line">  path: path,</div><div class="line">  query: query,</div><div class="line">  hash: hash</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样相当于提前normalizeLocation调用，所以在match再调用的时候直接返回自身<br>在接下来的match流程中,会进入以path为依据的流程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">else if (location.path) &#123;</div><div class="line">  location.params = &#123;&#125;;</div><div class="line">  for (var i = 0; i &lt; pathList.length; i++) &#123;</div><div class="line">    var path = pathList[i];</div><div class="line">    var record$1 = pathMap[path];//根据path拿到record对象</div><div class="line">    if (matchRoute(record$1.regex, location.path, location.params)) &#123;</div><div class="line">      return _createRoute(record$1, location, redirectedFrom)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据标签to赋予的path值，和生成路由表时拿到的path配置值，根据正则表达式解析params对象，<br>也说明了，为什么跳转路包含动态参数的path时，要跟params配对使用</p>
<h3 id="matchRoute"><a href="#matchRoute" class="headerlink" title="matchRoute"></a>matchRoute</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">function matchRoute (</div><div class="line">    regex,</div><div class="line">    path,</div><div class="line">    params</div><div class="line">  ) &#123;</div><div class="line">    var m = path.match(regex);</div><div class="line">    if (!m) &#123;//当前路由不符合route定义时格式</div><div class="line">      return false</div><div class="line">    &#125; else if (!params) &#123;</div><div class="line">      return true</div><div class="line">    &#125;</div><div class="line">    //匹配路由组装params</div><div class="line">    for (var i = 1, len = m.length; i &lt; len; ++i) &#123;</div><div class="line">      var key = regex.keys[i - 1];</div><div class="line">      var val = typeof m[i] === &apos;string&apos; ? decodeURIComponent(m[i]) : m[i];//始终为子字符串</div><div class="line">      if (key) &#123;</div><div class="line">        // Fix #1994: using * with props: true generates a param named 0</div><div class="line">        params[key.name || &apos;pathMatch&apos;] = val;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return true</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="直接更改url跳转"><a href="#直接更改url跳转" class="headerlink" title="直接更改url跳转"></a>直接更改url跳转</h2><p>在浏览器直接更改含有动态路由的的url，回车跳转，会根据事先绑定的监听事件进行解析处理<br>在new vue时初始化完当前路由，以执行回调的方式绑定监听<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">  VueRouter.prototype.init = function init (app /* Vue component instance */) &#123;</div><div class="line">  var this$1 = this;</div><div class="line"></div><div class="line">  this.app = app;</div><div class="line"></div><div class="line">  var history = this.history;</div><div class="line"></div><div class="line">  if (history instanceof HTML5History) &#123; //h5history在new h5history时，在构造函数中设置popstate事件监听</div><div class="line">    history.transitionTo(history.getCurrentLocation());</div><div class="line">  &#125; else if (history instanceof HashHistory) &#123;</div><div class="line">    var setupHashListener = function () &#123;</div><div class="line">      history.setupListeners();//设置监听</div><div class="line">    &#125;;</div><div class="line">    history.transitionTo( //无论成功与否都绑定</div><div class="line">      history.getCurrentLocation(),</div><div class="line">      setupHashListener, </div><div class="line">      setupHashListener</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  history.listen(function (route) &#123; //route改变时调用，this.cb</div><div class="line">    this$1.apps.forEach(function (app) &#123;</div><div class="line">      app._route = route;</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>设置监听具体内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">HashHistory.prototype.setupListeners = function setupListeners () &#123;</div><div class="line">    var this$1 = this;</div><div class="line"></div><div class="line">    var router = this.router;</div><div class="line">    var expectScroll = router.options.scrollBehavior;</div><div class="line">    var supportsScroll = supportsPushState &amp;&amp; expectScroll;</div><div class="line"></div><div class="line">    if (supportsScroll) &#123;</div><div class="line">      setupScroll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    window.addEventListener(</div><div class="line">      supportsPushState ? &apos;popstate&apos; : &apos;hashchange&apos;,</div><div class="line">      function () &#123;</div><div class="line">        var current = this$1.current;</div><div class="line">        if (!ensureSlash()) &#123;</div><div class="line">          return</div><div class="line">      &#125;</div><div class="line">       //直接调用transitionTo进行路由更新</div><div class="line">      this$1.transitionTo(getHash(), function (route) &#123; //成功回调不用pushHash更新url</div><div class="line">        if (supportsScroll) &#123;</div><div class="line">          handleScroll(this$1.router, route, current, true);</div><div class="line">        &#125;</div><div class="line">        if (!supportsPushState) &#123;</div><div class="line">          replaceHash(route.fullPath);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  );</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>可见通过监听事件触发的路由改变会直接调用transitionTo函数进行跳转</p>
<h1 id="两个收获"><a href="#两个收获" class="headerlink" title="两个收获"></a>两个收获</h1><p>1.normalizeLocation函数发挥的作用，根据第一参数location对象不同的属性状态进行不同的处理，用于在上游的不同情境(不同方式导致跳转)使用中统一调用<br>2.在transitionTo函数中调用comfirmTransition,为什么不直接在transitionTo函数中书写confirmTransition函数内容呢，为什么要单独摘出来呢？同样，comfirmTransition函数不止会在transition中调用,<br>还会在AbstractHistory的go函数中被直接调用，HashHistory和HTML5History的go方法会直接使用window.history.go(n);nodejs全局对象是global,不是windows,所以需要特殊处理</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoohannah.github.io/post/vue/vuex1.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="YooHannah">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/psb.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="My Little World">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="My Little World" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/vue/vuex1.html" itemprop="url">
                  vuex 一些api使用规则
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-05T12:41:15+08:00">
                2020-02-05
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://vuex.vuejs.org/zh/" target="_blank" rel="external">官网地址</a><br>基本思想：<br>通过定义和隔离状态管理中的各种概念并通过强制规则维持视图和状态间的独立性<br>以一个全局单例模式管理抽取出来的组件共享状态<br><img src="/image/vuex.png" alt="思路图"></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Vue.use(Vuex) //会调用install，在beforeMount声明周期进行初始化工作</div><div class="line"></div><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123;</div><div class="line">    count: 0</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123;</div><div class="line">      state.count++</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">const app = new Vue(&#123;</div><div class="line">  el: &apos;#app&apos;,</div><div class="line">  // 把 store 对象提供给 “store” 选项，这可以把 store 的实例注入所有的子组件</div><div class="line">  store,</div><div class="line">  components: &#123; Counter &#125;,</div><div class="line">  template: `</div><div class="line">    &lt;div class=&quot;app&quot;&gt;</div><div class="line">      &lt;counter&gt;&lt;/counter&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  `</div><div class="line">&#125;)</div><div class="line"></div><div class="line">const Counter = &#123;</div><div class="line">  template: `&lt;div&gt;&#123;&#123; count &#125;&#125;&lt;/div&gt;`,</div><div class="line">  computed: &#123;</div><div class="line">    count () &#123;</div><div class="line">      return this.$store.state.count</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="state"><a href="#state" class="headerlink" title="state"></a>state</h1><p>具体变量声明对象，存放每个具体的公共变量</p>
<p>声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123;</div><div class="line">    count: 0</div><div class="line">  &#125;,</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>在vue中使用—访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this.$store.state.count</div></pre></td></tr></table></figure></p>
<p><a href="https://vuex.vuejs.org/zh/guide/state.html#mapstate-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0" target="_blank" rel="external">辅助函数mapstate</a></p>
<h1 id="getter"><a href="#getter" class="headerlink" title="getter"></a>getter</h1><p>相当与vue的计算属性<br>访问声明的属性时，执行对应的函数，拿到的值为函数返回的值<br>如果函数返回另一个函数，则可以调用返回的函数去实现相应的功能<br>适用于多个组件共享一个同样处理逻辑的函数</p>
<p>getter 的返回值会根据它的依赖被缓存起来<br>且只有当它的依赖值发生了改变才会被重新计算<br>Getter 接受 state 作为其第一个参数</p>
<p>声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123;</div><div class="line">    todos: [</div><div class="line">      &#123; id: 1, text: &apos;...&apos;, done: true &#125;,</div><div class="line">      &#123; id: 2, text: &apos;...&apos;, done: false &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  getters: &#123;</div><div class="line">    doneTodos: state =&gt; &#123;</div><div class="line">      return state.todos.filter(todo =&gt; todo.done)</div><div class="line">    &#125;,</div><div class="line">    // 受其他 getter 作为第二个参数,调用其他getter方法</div><div class="line">    doneTodosCount: (state, getters) =&gt; &#123;</div><div class="line">      return getters.doneTodos.length</div><div class="line">    &#125;</div><div class="line">    getTodoById: (state) =&gt; (id) =&gt; &#123;</div><div class="line">      return state.todos.find(todo =&gt; todo.id === id)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>在vue中使用—访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">this.$store.getters.doneTodos // -&gt; [&#123; id: 1, text: &apos;...&apos;, done: true &#125;]</div><div class="line">this.$store.getters.doneTodosCount // -&gt; 1</div><div class="line">this.$store.getters.getTodoById(2) // -&gt; &#123; id: 2, text: &apos;...&apos;, done: false &#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://vuex.vuejs.org/zh/guide/getters.html#mapgetters-%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0" target="_blank" rel="external">映射辅助函数mapGetters</a></p>
<h1 id="Mutation"><a href="#Mutation" class="headerlink" title="Mutation"></a>Mutation</h1><p>存储同步改变state保存值的方法</p>
<p>声明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123;</div><div class="line">    count: 1</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state, payload) &#123; //payload即调用时传递进来的参数</div><div class="line">      state.count += payload.amount</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>在vue中使用—调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">this.$store.commit(&apos;increment&apos;, &#123;</div><div class="line">  amount: 10</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>注意事项<br>1.提前在 store 中初始化好所有所需属性。<br>2.当需要在对象上添加新属性时，应该使用 Vue.set或者以新对象替换老对象<br><a href="https://vuex.vuejs.org/zh/guide/mutations.html#%E5%9C%A8%E7%BB%84%E4%BB%B6%E4%B8%AD%E6%8F%90%E4%BA%A4-mutation" target="_blank" rel="external">映射辅助函数mapMutations</a></p>
<h1 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h1><p>存储异步改变state保存值的方法<br>Action 函数接受一个与 store 实例具有相同方法和属性的 context 对象，因此你可以调用 context.commit 提交一个 mutation，或者通过 context.state 和 context.getters 来获取 state 和 getters。但他不是 store 实例本身<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123;</div><div class="line">    count: 0</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123;</div><div class="line">      state.count++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  actions: &#123;</div><div class="line">    increment (context) &#123;</div><div class="line">      context.commit(&apos;increment&apos;)</div><div class="line">    &#125;,</div><div class="line">    incrementAsync (&#123; commit &#125;) &#123; //结构仅拿到contex里面的commit</div><div class="line">      setTimeout(() =&gt; &#123;</div><div class="line">        commit(&apos;increment&apos;)</div><div class="line">      &#125;, 1000)</div><div class="line">    &#125;,</div><div class="line">    actionA (&#123; commit &#125;) &#123;</div><div class="line">      return new Promise((resolve, reject) =&gt; &#123;</div><div class="line">        setTimeout(() =&gt; &#123;</div><div class="line">          commit(&apos;someMutation&apos;)</div><div class="line">          resolve()</div><div class="line">        &#125;, 1000)</div><div class="line">      &#125;)</div><div class="line">    &#125;,</div><div class="line">    actionB (&#123; dispatch, commit &#125;) &#123;</div><div class="line">      return dispatch(&apos;actionA&apos;).then(() =&gt; &#123;</div><div class="line">        commit(&apos;someOtherMutation&apos;)</div><div class="line">      &#125;)</div><div class="line">    &#125;,</div><div class="line">    async actionA (&#123; commit &#125;) &#123;</div><div class="line">      commit(&apos;gotData&apos;, await getData())</div><div class="line">    &#125;,</div><div class="line">    async actionB (&#123; dispatch, commit &#125;) &#123;</div><div class="line">      await dispatch(&apos;actionA&apos;) // 等待 actionA 完成</div><div class="line">      commit(&apos;gotOtherData&apos;, await getOtherData())</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>在VUE中使用—调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">this.$store.dispatch(&apos;incrementAsync&apos;, &#123; //作为第二个参数传递action</div><div class="line">  amount: 10</div><div class="line">&#125;)</div><div class="line"></div><div class="line">this.$store.dispatch(&apos;actionA&apos;).then(() =&gt; &#123;</div><div class="line">  // ...</div><div class="line">&#125;)</div><div class="line"></div><div class="line">this.$store.dispatch(&apos;actionB&apos;).then(() =&gt; &#123;</div><div class="line">  // ...</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<h1 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h1><p>声明多个store配置对象，每个作为一个模块<br>每个模块拥有自己的 state、mutation、action、getter、甚至是嵌套子模块<br>套嵌条件下,state 会处理成树状结构进行访问，但要进行更改操作时，<br>如果有子模块没有进行命名空间设置，但又包含跟全局状态相同处理名称的 mutation 或 action<br>则在调用时，都会执行</p>
<p>默认情况下，模块内部的 action、mutation 和 getter 是注册在全局命名空间的——这样使得多个模块能够对同一 mutation 或 action 作出响应。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">let moduleA = &#123;</div><div class="line">  namespaced: true,</div><div class="line">  state()&#123; </div><div class="line">    return&#123;</div><div class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </div><div class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </div><div class="line">      state.counta++</div><div class="line">    &#125;,</div><div class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</div><div class="line">      state.counta++</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">let moduleB = &#123;</div><div class="line">  namespaced: true,</div><div class="line">  state: &#123; </div><div class="line">    countb: 0,//this.$store.state.b.countb</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</div><div class="line">      state.countb++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</div><div class="line">    aa: moduleA,//this.$store.state.b.aa.counta</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">// vuex相关代码</div><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123; </div><div class="line">    count: 0, //this.$store.state.count</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</div><div class="line">      state.count++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  modules: &#123;</div><div class="line">    a: moduleA, //this.$store.state.a.counta</div><div class="line">    b: moduleB //this.$store.state.b.countb</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>小结<br>namespaced: true相当于子模块的隔离层，<br>如果设置了，外界不能直接通过mutations里面的函数名进行commit调用，<br>即当调用相同函数名时，可以防止一起被调用<br>如果没有设置，则当调用相同类型commit时，会一起被调用</p>
<p>1.对于模块内部的 mutation 和 getter，接收的第一个参数是模块的局部状态对象。<br>2.带命名空间的模块。当模块被注册后，它的所有 getter、action 及 mutation 都会自动根据模块注册的路径调整命名<br>3.对于模块内部的 action，局部状态通过 context.state 暴露出来，根节点状态则为 context.rootState<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">const moduleA = &#123;</div><div class="line">  </div><div class="line">  namespaced: true,</div><div class="line"></div><div class="line">  state: &#123; count: 0 &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123;</div><div class="line">      // 这里的 `state` 对象是模块的局部状态</div><div class="line">      state.count++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  getters: &#123;</div><div class="line">    doubleCount (state) &#123;</div><div class="line">      return state.count * 2</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  </div><div class="line">  actions: &#123;</div><div class="line">    incrementIfOddOnRootSum (&#123; state, commit, rootState &#125;) &#123;</div><div class="line">      if ((state.count + rootState.count) % 2 === 1) &#123;</div><div class="line">        commit(&apos;increment&apos;)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更新补充<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">let moduleA = &#123;</div><div class="line">  namespaced: true,</div><div class="line">  state()&#123; </div><div class="line">    return&#123;</div><div class="line">      counta: 0, //分别在模块b和全局下被使用，直接返回对象会通过引用被共享，防止模块间数据污染，使用函数，每次生成新对象，原理同vue的data</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  getters:&#123;</div><div class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/aa/getCount&apos;] 作为b子模块时</div><div class="line">      console.log(args)</div><div class="line">      return  &apos;this is a getter~~~~~&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123; // this.$store.commit(&apos;b/aa/increment&apos;) 仅触发模块b下面的aa子模块  </div><div class="line">    increment (state) &#123; //this.$store.commit(&apos;a/increment&apos;) 仅触发全局的模块a 对应的子模块 </div><div class="line">      state.counta++</div><div class="line">    &#125;,</div><div class="line">    incrementaaa (state) &#123; //在被引用时，套嵌层如果都没有namespaced: true,可以直接用this.$store.commit(&apos;incrementaaa&apos;)调用进行更改</div><div class="line">      state.counta++</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">let moduleB = &#123;</div><div class="line">  namespaced: true,</div><div class="line">  state: &#123; </div><div class="line">    countb: 0,//this.$store.state.b.countb</div><div class="line">  &#125;,</div><div class="line">  getters:&#123;</div><div class="line">    getCount(...args)&#123; //this.$store.getters[&apos;b/getCount&apos;] 因为设置了namespaced所以可以重名</div><div class="line">      console.log(args)</div><div class="line">      return  &apos;this is a getter~~~~~&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123; //如果不加namespaced，执行this.$store.commit(&apos;increment&apos;)，会同时执行</div><div class="line">      state.countb++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  modules: &#123;//如果moduleB不加namespaced，aa可以访问数据但不能调用this.$store.commit(&apos;b/aa/increment&apos;)进行更改</div><div class="line">    aa: moduleA,//this.$store.state.b.aa.counta</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">// vuex相关代码</div><div class="line">const store = new Vuex.Store(&#123;</div><div class="line">  state: &#123; </div><div class="line">    count: 0, //this.$store.state.count</div><div class="line">  &#125;,</div><div class="line">  getters:&#123;</div><div class="line">    getCount(...args)&#123; //this.$store.getters.getCount</div><div class="line">      console.log(args)</div><div class="line">      return  &apos;this is a getter&apos;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  mutations: &#123;</div><div class="line">    increment (state) &#123; //this.$store.commit(&apos;increment&apos;) 子模块有相同函数时，都会触发执行</div><div class="line">      state.count++</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  modules: &#123;</div><div class="line">    a: moduleA, //this.$store.state.a.counta</div><div class="line">    b: moduleB //this.$store.state.b.countb</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/psb.jpg"
               alt="YooHannah" />
          <p class="site-author-name" itemprop="name">YooHannah</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">193</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YooHannah</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/treedocument/treedocument.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
